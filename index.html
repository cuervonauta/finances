<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4f46e5">
    <title>Finanzas | Control Total</title>
    
    <!-- Icono de pesta√±a -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí∏</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%234f46e5%22 rx=%2220%22 ry=%2220%22></rect><text x=%2250%22 y=%2250%22 dominant-baseline=%22central%22 text-anchor=%22middle%22 font-size=%2260%22>üí∏</text></svg>">

    <!-- Librer√≠as Externas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { 
            -webkit-tap-highlight-color: transparent; 
            overscroll-behavior-y: none; 
            background-color: #f3f4f6; 
        }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        .slide-up { animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        /* Scrollbar personalizado para desktop */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body>
    <div id="root">
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; color: #6b7280; font-family: sans-serif; background-color: #f3f4f6;">
            <div style="border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #4f46e5; animation: spin 1s linear infinite; margin-bottom: 1rem;"></div>
            <h2 style="font-size: 1.2rem; font-weight: bold; color: #374151;">Cargando App...</h2>
        </div>
        <style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useRef, Component } = React;
        const USD_VALUE = 950; 

        // --- THEMES ---
        const THEMES = {
            indigo: { name: '√çndigo', bg: 'bg-indigo-600', border: 'border-indigo-200', text: 'text-indigo-600', light: 'bg-indigo-50', hover: 'hover:bg-indigo-700', ring: 'ring-indigo-500', sidebar: 'bg-indigo-900', sidebarHover: 'hover:bg-indigo-800' },
            emerald: { name: 'Esmeralda', bg: 'bg-emerald-600', border: 'border-emerald-200', text: 'text-emerald-600', light: 'bg-emerald-50', hover: 'hover:bg-emerald-700', ring: 'ring-emerald-500', sidebar: 'bg-emerald-900', sidebarHover: 'hover:bg-emerald-800' },
            rose: { name: 'Rosa', bg: 'bg-rose-600', border: 'border-rose-200', text: 'text-rose-600', light: 'bg-rose-50', hover: 'hover:bg-rose-700', ring: 'ring-rose-500', sidebar: 'bg-rose-900', sidebarHover: 'hover:bg-rose-800' },
            blue: { name: 'Azul', bg: 'bg-blue-600', border: 'border-blue-200', text: 'text-blue-600', light: 'bg-blue-50', hover: 'hover:bg-blue-700', ring: 'ring-blue-500', sidebar: 'bg-blue-900', sidebarHover: 'hover:bg-blue-800' },
            purple: { name: 'P√∫rpura', bg: 'bg-purple-600', border: 'border-purple-200', text: 'text-purple-600', light: 'bg-purple-50', hover: 'hover:bg-purple-700', ring: 'ring-purple-500', sidebar: 'bg-purple-900', sidebarHover: 'hover:bg-purple-800' },
            slate: { name: 'Oscuro', bg: 'bg-slate-800', border: 'border-slate-300', text: 'text-slate-800', light: 'bg-slate-100', hover: 'hover:bg-slate-900', ring: 'ring-slate-500', sidebar: 'bg-slate-900', sidebarHover: 'hover:bg-slate-800' },
        };

        class ErrorBoundary extends Component {
            constructor(props) { super(props); this.state = { hasError: false }; }
            static getDerivedStateFromError(error) { return { hasError: true }; }
            componentDidCatch(error, errorInfo) { console.error("Error App:", error, errorInfo); }
            render() {
                if (this.state.hasError) return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-6 text-center">
                        <h1 className="text-2xl font-bold text-red-600 mb-2">¬°Ups! Algo sali√≥ mal</h1>
                        <button onClick={() => { localStorage.clear(); window.location.reload(); }} className="bg-red-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg">‚ôªÔ∏è Reiniciar Todo</button>
                    </div>
                );
                return this.props.children;
            }
        }

        // --- ICONOS ---
        const Icon = ({ path, size = 24, className = "" }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} dangerouslySetInnerHTML={{ __html: path }} />);
        
        const ICONS = {
            Google: '<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z" fill="none"/><path d="M20.283 10.356h-8.327v3.451h4.792c-.446 2.193-2.313 3.453-4.792 3.453a5.27 5.27 0 0 1-5.279-5.28 5.27 5.27 0 0 1 5.279-5.279c1.259 0 2.397.447 3.29 1.178l2.6-2.599c-1.584-1.381-3.615-2.233-5.89-2.233a8.908 8.908 0 0 0-8.934 8.934 8.907 8.907 0 0 0 8.934 8.934c4.467 0 8.529-3.249 8.529-8.934 0-.528-.081-1.097-.202-1.625z" fill="currentColor"/>',
            Wallet: '<path d="M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h15a1 1 0 0 1 1 1v4h-3a2 2 0 0 0 0 4h3a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1"/><path d="M3 5v14a2 2 0 0 0 2 2h15a1 1 0 0 0 1-1v-4"/>',
            Home: '<path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/>',
            Store: '<path d="m2 7 4.41-4.41A2 2 0 0 1 7.83 2h8.34a2 2 0 0 1 1.42.59L22 7"/><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><path d="M15 22v-4a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v4"/><path d="M2 7h20"/><path d="M22 7v3a2 2 0 0 1-2 2v0a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 16 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 12 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 8 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 4 12v0a2 2 0 0 1-2-2V7"/>',
            CreditCard: '<rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/>',
            ShoppingCart: '<circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/>',
            Coffee: '<path d="M17 8h1a4 4 0 1 1 0 8h-1"/><path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/><line x1="6" x2="6" y1="2" y2="4"/><line x1="10" x2="10" y1="2" y2="4"/><line x1="14" x2="14" y1="2" y2="4"/>',
            MapPin: '<path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/>',
            Plus: '<path d="M5 12h14"/><path d="M12 5v14"/>',
            Trash2: '<path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/>',
            CheckCircle2: '<path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4"/>',
            Circle: '<circle cx="12" cy="12" r="10"/>',
            RotateCcw: '<path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/>',
            DollarSign: '<line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>',
            Smartphone: '<rect width="14" height="20" x="5" y="2" rx="2" ry="2"/><path d="M12 18h.01"/>',
            ShieldCheck: '<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="m9 12 2 2 4-4"/>',
            Building2: '<path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z"/><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"/><path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2"/><path d="M10 6h4"/><path d="M10 10h4"/><path d="M10 14h4"/><path d="M10 18h4"/>',
            FolderPlus: '<path d="M12 10v6"/><path d="M9 13h6"/><path d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z"/>',
            Edit2: '<path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>',
            Calendar: '<rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/>',
            Lock: '<rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>',
            Unlock: '<rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/>',
            ChevronDown: '<path d="m6 9 6 6 6-6"/>',
            ChevronUp: '<path d="m18 15-6-6-6 6"/>',
            PiggyBank: '<path d="M19 5c-1.5 0-2.8.6-3.5 1.3a1 1 0 0 1-.9.7h-2.1c-.9 0-1.7.5-2.3 1.3a1 1 0 0 1-1.9-.7L10 3a2 2 0 0 0-2-2 2 2 0 0 0-2 2v2"/><path d="M5.5 8.5C3.5 9 2 11 2 13.5a2.5 2.5 0 0 0 2.5 2.5h15c1.1 0 2 .9 2 2v1"/><path d="M14 13h2"/><path d="M16 17v2a2 2 0 0 1-2 2h-1.5a2 2 0 0 1-2-2v-1"/><path d="M8 16v2a2 2 0 0 1-2 2H4.5a2 2 0 0 1-2-2v-1"/>',
            Users: '<path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>',
            ArrowLeft: '<path d="m12 19-7-7 7-7"/><path d="M19 12H5"/>',
            ChevronRight: '<path d="m9 18 6-6-6-6"/>',
            CalendarDays: '<rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/><path d="M8 14h.01"/><path d="M12 14h.01"/><path d="M16 14h.01"/><path d="M8 18h.01"/><path d="M12 18h.01"/><path d="M16 18h.01"/>',
            Cloud: '<path d="M17.5 19c0-1.7-1.3-3-3-3h-1.1c-.5-2.2-2.3-4-4.4-4-2.8 0-5 2.2-5 5 .5 0 1 0 1.5.1C6.7 15.6 8 14 9.5 14c1.8 0 3.3 1.3 3.5 3h.5c.8 0 1.5.7 1.5 1.5s-.7 1.5-1.5 1.5h-8"/><path d="M5 19h14.5c2.5 0 4.5-2 4.5-4.5S22 10 19.5 10c-.4 0-.7.1-1.1.2C17.7 7.2 14.8 5 11.5 5 7 5 3.3 8.3 2.5 12.6A4.5 4.5 0 0 0 5 19Z"/>',
            Check: '<path d="M20 6 9 17l-5-5"/>',
            Loader2: '<path d="M21 12a9 9 0 1 1-6.219-8.56"/>',
            Settings: '<path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.1a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/>',
            X: '<path d="M18 6 6 18"/><path d="m6 6 12 12"/>',
            BarChart3: '<path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/>',
            PieChart: '<path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/>',
            Download: '<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/>',
            Upload: '<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/>',
            FileJson: '<path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M10 13a1 1 0 0 0-1 1v1a1 1 0 0 1-1 1"/><path d="M14 16a1 1 0 0 1-1-1v-1a1 1 0 0 0-1-1"/>',
            Info: '<circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/>',
            LayoutDashboard: '<rect width="7" height="9" x="3" y="3" rx="1" /><rect width="7" height="5" x="14" y="3" rx="1" /><rect width="7" height="9" x="14" y="12" rx="1" /><rect width="7" height="5" x="3" y="16" rx="1" />',
            Banknote: '<rect width="20" height="12" x="2" y="6" rx="2"/><circle cx="12" cy="12" r="2"/><path d="M6 12h.01M18 12h.01"/>',
            List: '<line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/>',
            AlertTriangle: '<path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/>',
            UserCircle: '<circle cx="12" cy="12" r="10"/><circle cx="12" cy="10" r="3"/><path d="M7 20.662V19a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v1.662"/>',
            Palette: '<circle cx="13.5" cy="6.5" r=".5"/><circle cx="17.5" cy="10.5" r=".5"/><circle cx="8.5" cy="7.5" r=".5"/><circle cx="6.5" cy="12.5" r=".5"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"/>',
            Logout: '<path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/>',
            Briefcase: '<rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>',
            User: '<path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>',
            TrendingUp: '<polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/>',
            Package: '<path d="m7.5 4.27 9 5.15"/><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22v-9"/>',
            Presentation: '<path d="M2 3h20"/><path d="M21 3v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V3"/><path d="m7 21 5-5 5 5"/>',
            Menu: '<line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/>'
        };

        const Icons = Object.keys(ICONS).reduce((acc, key) => {
            acc[key] = (props) => <Icon path={ICONS[key]} {...props} />;
            return acc;
        }, {});

        const { 
            Wallet, Home, CreditCard, ShoppingCart, Coffee, MapPin, Plus, Trash2, 
            CheckCircle2, Circle, RotateCcw, DollarSign, Smartphone, ShieldCheck, 
            Building2, FolderPlus, Edit2, Calendar, Lock, Unlock, ChevronDown, ChevronUp,
            PiggyBank, Users, ArrowLeft, ChevronRight, CalendarDays, Cloud, 
            Check, Loader2, Settings, X, BarChart3, PieChart, Download, Upload, FileJson, Info, LayoutDashboard, Banknote,
            List, AlertTriangle, UserCircle, Palette, Google, Logout, Briefcase, User, Store,
            TrendingUp, Package, Presentation, Menu
        } = Icons;

        const formatCurrency = (amount) => new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP', minimumFractionDigits: 0 }).format(amount);
        const MONTHS = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

        // --- COMPONENTES LOGIN & ONBOARDING ---
        const LoginScreen = ({ onLogin }) => {
            const [isLoading, setIsLoading] = useState(false);
            
            const handleLogin = () => {
                setIsLoading(true);
                // Simulaci√≥n de delay de red para Google Auth
                setTimeout(() => {
                    const mockUser = {
                        // name: "Usuario Google", // Ya no forzamos el nombre aqu√≠
                        email: "usuario@gmail.com",
                        photo: null
                    };
                    onLogin(mockUser);
                }, 1500);
            };

            return (
                <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-white slide-up">
                    <div className="w-full max-w-sm">
                        <div className="flex justify-center mb-8">
                            <div className="p-4 bg-indigo-50 rounded-2xl">
                                <span className="text-4xl">üí∏</span>
                            </div>
                        </div>
                        <h1 className="text-2xl font-bold text-center text-gray-800 mb-2">Bienvenido a Mis Finanzas</h1>
                        <p className="text-center text-gray-500 mb-8 text-sm">Gestiona tus ingresos y gastos de forma inteligente y segura.</p>
                        
                        <div className="space-y-4">
                            <button 
                                onClick={handleLogin}
                                disabled={isLoading}
                                className="w-full flex items-center justify-center gap-3 bg-white border border-gray-200 text-gray-700 font-medium py-3 px-4 rounded-xl hover:bg-gray-50 transition-all shadow-sm relative overflow-hidden"
                            >
                                {isLoading ? (
                                    <Loader2 className="animate-spin text-gray-400" size={20}/>
                                ) : (
                                    <>
                                        <Google size={20}/> <span>Continuar con Google</span>
                                    </>
                                )}
                            </button>
                            <p className="text-xs text-center text-gray-400 mt-6">
                                Al continuar, aceptas nuestros t√©rminos de servicio y pol√≠tica de privacidad.
                            </p>
                        </div>
                    </div>
                </div>
            );
        };

        const NameSetupScreen = ({ onSaveName }) => {
            const [name, setName] = useState('');
            return (
                <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-white slide-up">
                    <div className="w-full max-w-sm">
                        <div className="flex justify-center mb-6">
                            <div className="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600">
                                <UserCircle size={32}/>
                            </div>
                        </div>
                        <h2 className="text-2xl font-bold text-center text-gray-800 mb-2">¬°Hola!</h2>
                        <p className="text-center text-gray-500 mb-8 text-sm">¬øC√≥mo te gustar√≠a que te llamemos?</p>
                        
                        <div className="space-y-4">
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase ml-1 mb-1 block">Tu Nombre</label>
                                <input 
                                    autoFocus
                                    className="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-lg font-medium focus:outline-none focus:border-indigo-500 transition-colors"
                                    placeholder="Ej. Alex"
                                    value={name}
                                    onChange={(e) => setName(e.target.value)}
                                    onKeyDown={(e) => e.key === 'Enter' && name.trim() && onSaveName(name)}
                                />
                            </div>
                            <button 
                                onClick={() => onSaveName(name)}
                                disabled={!name.trim()}
                                className="w-full bg-indigo-600 text-white font-bold py-3.5 rounded-xl hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-lg shadow-indigo-200"
                            >
                                Continuar
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const OnboardingScreen = ({ onSelectMode }) => {
            return (
                <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-gray-50 slide-up">
                    <div className="w-full max-w-sm">
                        <h2 className="text-2xl font-bold text-gray-800 mb-2">Configuremos tu espacio</h2>
                        <p className="text-gray-500 mb-8 text-sm">¬øQu√© tipo de finanzas deseas gestionar?</p>
                        
                        <div className="grid gap-4">
                            <button 
                                onClick={() => onSelectMode('personal')}
                                className="group bg-white p-6 rounded-2xl border border-gray-200 hover:border-indigo-500 hover:shadow-md transition-all text-left"
                            >
                                <div className="w-12 h-12 bg-indigo-50 rounded-full flex items-center justify-center text-indigo-600 mb-4 group-hover:bg-indigo-600 group-hover:text-white transition-colors">
                                    <User size={24}/>
                                </div>
                                <h3 className="font-bold text-gray-800 text-lg">Finanzas Personales</h3>
                                <p className="text-xs text-gray-500 mt-1">Hogar, suscripciones, tarjetas de cr√©dito y ahorros personales.</p>
                            </button>

                            <button 
                                onClick={() => onSelectMode('business')}
                                className="group bg-white p-6 rounded-2xl border border-gray-200 hover:border-emerald-500 hover:shadow-md transition-all text-left"
                            >
                                <div className="w-12 h-12 bg-emerald-50 rounded-full flex items-center justify-center text-emerald-600 mb-4 group-hover:bg-emerald-600 group-hover:text-white transition-colors">
                                    <Briefcase size={24}/>
                                </div>
                                <h3 className="font-bold text-gray-800 text-lg">Mi Negocio</h3>
                                <p className="text-xs text-gray-500 mt-1">Costos operativos, proveedores, insumos y flujo de caja.</p>
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- COMPONENTES UI ADAPTATIVOS ---
        const DesktopSidebar = ({ currentView, onChangeView, labels, theme, onSettings }) => {
            const menuItems = [
                { id: 'dashboard', label: 'Resumen', icon: LayoutDashboard },
                { id: 'hogar', label: labels.hogarTitle, icon: labels.hogarIcon },
                { id: 'tarjetas', label: 'Tarjetas', icon: CreditCard },
                { id: 'supermercado', label: labels.superTitle, icon: ShoppingCart },
                { id: 'ahorros', label: 'Reservas', icon: PiggyBank },
                { id: 'graficos', label: 'Gr√°ficos', icon: BarChart3 }
            ];

            if (labels.mode === 'business') {
                menuItems.splice(1, 0, { id: 'ingresos', label: 'Ingresos', icon: TrendingUp });
            }

            return (
                <div className={`hidden md:flex flex-col w-64 ${theme.sidebar} text-white h-screen sticky top-0 shadow-xl z-50`}>
                    <div className="p-6 flex items-center gap-3">
                        <div className="p-2 bg-white/10 rounded-lg"><span className="text-2xl">üí∏</span></div>
                        <span className="font-bold text-lg tracking-wide">Mis Finanzas</span>
                    </div>
                    <nav className="flex-1 px-4 space-y-1">
                        {menuItems.map(item => (
                            <button
                                key={item.id}
                                onClick={() => onChangeView(item.id)}
                                className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all font-medium text-sm ${currentView === item.id ? 'bg-white text-gray-900 shadow-md' : `text-white/70 ${theme.sidebarHover} hover:text-white`}`}
                            >
                                <item.icon size={18} className={currentView === item.id ? theme.text : ''} />
                                {item.label}
                            </button>
                        ))}
                    </nav>
                    <div className="p-4 border-t border-white/10">
                        <button onClick={onSettings} className="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-white/70 hover:bg-white/10 hover:text-white transition-all text-sm font-medium">
                            <Settings size={18}/> Configuraci√≥n
                        </button>
                    </div>
                </div>
            );
        };

        const SectionCard = ({ title, icon: Icon, total, paid, children, colorClass, headerClass, onDeleteSection, readOnly, onTitleChange }) => {
            const hasPaidProp = typeof paid !== 'undefined';
            const remaining = Math.max(0, total - (paid || 0));
            const progress = hasPaidProp && total > 0 ? (paid / total) * 100 : 0;

            return (
                <section className={`rounded-2xl shadow-sm border border-gray-100 overflow-hidden bg-white transition-all hover:shadow-md flex flex-col h-full`}>
                    <div className={`px-4 py-3 flex justify-between items-start relative overflow-hidden shrink-0 ${headerClass}`}>
                        {hasPaidProp && (
                            <div className="absolute bottom-0 left-0 w-full h-1 bg-black/5">
                                <div className="h-full bg-current opacity-40 transition-all duration-500" style={{ width: `${progress}%` }}></div>
                            </div>
                        )}
                        <div className="flex items-center gap-2 mt-0.5 flex-1 relative z-10 overflow-hidden">
                            <div className="p-1.5 bg-white/20 rounded-lg backdrop-blur-sm shadow-sm">
                                <Icon size={16} className="shrink-0" />
                            </div>
                            {onTitleChange && !readOnly ? (
                                <input 
                                    type="text" 
                                    value={title} 
                                    onChange={(e) => onTitleChange(e.target.value)} 
                                    className="font-bold text-base bg-transparent border-b border-dashed border-current/30 focus:border-current focus:outline-none w-full mr-2 placeholder-current/50 truncate"
                                />
                            ) : (
                                <span className="font-bold text-base truncate">{title}</span>
                            )}
                        </div>
                        <div className="flex flex-col items-end gap-0.5 shrink-0 relative z-10 ml-2">
                            <span className="text-lg font-extrabold leading-none tracking-tight">{formatCurrency(hasPaidProp ? remaining : total)}</span>
                            {hasPaidProp && (
                                <div className="flex items-center gap-1 text-[9px] font-bold opacity-70 bg-white/20 px-1.5 py-0.5 rounded-full mt-0.5">
                                    <span>{Math.round(progress)}%</span>
                                </div>
                            )}
                            {onDeleteSection && !readOnly && <button onClick={onDeleteSection} className="opacity-50 hover:opacity-100 mt-1 absolute -right-2 -top-2 p-2"><Trash2 size={14}/></button>}
                        </div>
                    </div>
                    <div className={`p-2 flex-1 ${readOnly ? 'pointer-events-none opacity-80' : ''}`}>
                        <div className="space-y-1">{children}</div>
                    </div>
                </section>
            );
        };

        const CategoryButton = ({ title, icon: Icon, color, onClick, total, subtitle, showAmount = true }) => (
            <button onClick={onClick} className="w-full bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between hover:shadow-md transition-all active:scale-95 mb-3 md:mb-0 h-full group">
                <div className="flex items-center gap-3">
                    <div className={`p-3 rounded-xl ${color.bg} ${color.text} group-hover:scale-110 transition-transform`}><Icon size={24}/></div>
                    <div className="text-left"><h3 className="font-bold text-gray-800">{title}</h3><p className="text-xs text-gray-400">{subtitle || "Ver detalles"}</p></div>
                </div>
                <div className="flex items-center gap-2">
                    {showAmount && <span className="text-xs font-bold text-gray-600 bg-gray-50 px-2 py-1 rounded">{formatCurrency(total)}</span>}
                    <ChevronRight className="text-gray-300 group-hover:translate-x-1 transition-transform" size={20}/>
                </div>
            </button>
        );

        // Componentes gen√©ricos 
        const CurrencyInput = ({ value, onChange, className, placeholder, disabled, autoFocus }) => {
            const format = (val) => { 
                if (val === '' || val === undefined || val === null) return ''; 
                return val.toString().replace(/\./g, '').replace(/\B(?=(\d{3})+(?!\d))/g, "."); 
            };
            const handleChange = (e) => { 
                const raw = e.target.value.replace(/\./g, ''); 
                if (!/^\d*$/.test(raw)) return; 
                onChange(raw); 
            };
            return (
                <input 
                    type="text" 
                    inputMode="numeric" 
                    value={format(value)} 
                    onChange={handleChange} 
                    className={className} 
                    placeholder={placeholder} 
                    disabled={disabled} 
                    autoFocus={autoFocus} 
                />
            );
        };

        const AddItemRow = ({ name, amount, onNameChange, onAmountChange, onAdd, placeholder = "Nuevo item..." }) => (
            <div className="mt-2 px-3 py-2 border border-dashed border-gray-200 rounded-xl flex items-center gap-2 group hover:border-gray-300 hover:bg-gray-50/50 transition-all focus-within:border-indigo-300 focus-within:bg-indigo-50/10">
                <div className="p-1.5 rounded-lg bg-gray-100 text-gray-400 group-hover:text-gray-600 transition-colors"><Plus size={14}/></div>
                <input 
                    className="flex-1 bg-transparent text-sm outline-none placeholder-gray-400 font-medium" 
                    placeholder={placeholder} 
                    value={name} 
                    onChange={onNameChange} 
                    onKeyDown={(e) => e.key === 'Enter' && onAdd()} 
                />
                <div className="w-px h-4 bg-gray-200"></div>
                <div className="relative w-20">
                    <span className="absolute left-0 top-1/2 -translate-y-1/2 text-gray-400 text-[10px]">$</span>
                    <CurrencyInput 
                        className="w-full bg-transparent text-right text-sm font-bold outline-none placeholder-gray-300 text-gray-700" 
                        placeholder="0" 
                        value={amount} 
                        onChange={onAmountChange} 
                        onKeyDown={(e) => e.key === 'Enter' && onAdd()} 
                    />
                </div>
                <button 
                    onClick={onAdd} 
                    disabled={!name || !amount} 
                    className="p-1.5 rounded-lg bg-gray-900 text-white opacity-0 group-focus-within:opacity-100 disabled:opacity-0 hover:bg-black transition-all shadow-sm"
                >
                    <Check size={14}/>
                </button>
            </div>
        );

        const EditableRow = ({ item, readOnly, onToggle, onAmountChange, onNameChange, showDelete, onDelete }) => (
            <div className={`group flex items-center justify-between px-3 py-2.5 rounded-lg transition-all hover:bg-gray-50 ${item.paid ? 'opacity-50' : ''}`}>
                <div className="flex items-center gap-3 flex-1">
                    <button onClick={!readOnly ? onToggle : undefined} className={`transition-all active:scale-90 ${item.paid ? 'text-emerald-500' : 'text-gray-300 hover:text-gray-400'}`}>
                        {item.paid ? <CheckCircle2 size={20} className="fill-emerald-100"/> : <Circle size={20}/>}
                    </button>
                    {!readOnly && onNameChange ? (
                        <input type="text" value={item.name} onChange={(e) => onNameChange(e.target.value)} className="font-medium text-gray-700 bg-transparent border-b border-dashed border-transparent hover:border-gray-300 focus:border-indigo-500 outline-none w-full transition-colors text-sm" />
                    ) : (
                        <span className={`font-medium text-sm ${item.paid ? 'line-through text-gray-400' : 'text-gray-700'}`}>{item.name}</span>
                    )}
                </div>
                <div className="flex items-center gap-2 pl-2">
                    <span className="text-[10px] text-gray-400 mt-0.5">$</span>
                    <CurrencyInput disabled={readOnly} value={item.amount} onChange={(val) => onAmountChange(val)} className={`w-20 text-right font-bold bg-transparent outline-none text-sm ${item.paid ? 'text-gray-400' : 'text-gray-800'}`}/>
                    {showDelete && !readOnly && <button onClick={onDelete} className="text-gray-300 hover:text-red-500 transition-colors opacity-0 group-hover:opacity-100 p-1"><Trash2 size={14}/></button>}
                </div>
            </div>
        );

        const DetailedCreditCardRow = ({ item, readOnly, onUpdate, onDelete }) => {
            const isPaid = item.status === 'paid' || item.status === 'no_debt';
            const isNoDebt = item.status === 'no_debt';
            const isLinea = item.type === 'linea';
            const available = (Number(item.limit) || 0) - (Number(item.totalDebt) || 0);
            
            return (
                <div className="border-b border-rose-100 last:border-0 py-4">
                    <div className="flex justify-between items-start mb-3">
                        <div>
                            <span className="text-xs font-bold text-rose-800 uppercase tracking-wide flex items-center gap-1">
                                {item.type === 'tc_pesos' ? <DollarSign size={12}/> : item.type === 'tc_dolares' ? <span className="text-[10px]">USD</span> : <RotateCcw size={12}/>}
                                {item.name}
                            </span>
                            <div className="flex items-center gap-2 mt-1.5">
                                <select 
                                    disabled={readOnly} 
                                    value={item.status} 
                                    onChange={(e) => onUpdate('status', e.target.value)} 
                                    className={`text-[10px] font-bold px-2 py-0.5 rounded-full appearance-none border transition-colors cursor-pointer outline-none ${item.status === 'paid' ? 'bg-emerald-50 text-emerald-600 border-emerald-100' : item.status === 'no_debt' ? 'bg-gray-50 text-gray-500 border-gray-100' : 'bg-white text-rose-600 border-rose-200 shadow-sm'}`}
                                >
                                    <option value="pending">Pendiente de Pago</option>
                                    <option value="paid">Pagado Completo</option>
                                    <option value="no_debt">Sin Deuda / Uso</option>
                                </select>
                            </div>
                        </div>
                        {!readOnly && <button onClick={onDelete} className="text-rose-200 hover:text-rose-500 p-1"><X size={16}/></button>}
                    </div>

                    {!isNoDebt && (
                        <div className="space-y-3 bg-rose-50/30 p-3 rounded-xl">
                            {!isLinea && (
                                <>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="text-[9px] text-gray-400 font-bold uppercase block mb-1">Deuda Total (Info)</label>
                                            <div className="relative">
                                                <span className="absolute left-2 top-1/2 -translate-y-1/2 text-gray-400 text-[10px]">$</span>
                                                <CurrencyInput disabled={readOnly} value={item.totalDebt} onChange={(val) => onUpdate('totalDebt', val)} className="w-full bg-white border border-gray-200 rounded-lg pl-5 pr-2 py-1.5 text-xs font-bold text-gray-600 focus:border-rose-400 focus:ring-1 focus:ring-rose-200 outline-none" placeholder="0" />
                                            </div>
                                        </div>
                                        <div>
                                            <label className="text-[9px] text-gray-400 font-bold uppercase block mb-1">Fecha Corte</label>
                                            <input type="date" disabled={readOnly} value={item.cutoffDate || ''} onChange={(e) => onUpdate('cutoffDate', e.target.value)} className="w-full bg-white border border-gray-200 rounded-lg px-2 py-1.5 text-xs font-bold text-gray-600 focus:border-rose-400 focus:ring-1 focus:ring-rose-200 outline-none" />
                                        </div>
                                    </div>
                                    <div className="h-px bg-rose-100/50"></div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="text-[9px] text-rose-600/70 font-bold uppercase block mb-1">Facturado (A Pagar)</label>
                                            <div className="relative">
                                                <span className="absolute left-2 top-1/2 -translate-y-1/2 text-rose-400 text-[10px]">$</span>
                                                <CurrencyInput disabled={readOnly} value={item.monthlyQuota} onChange={(val) => onUpdate('monthlyQuota', val)} className="w-full bg-white border border-rose-200 rounded-lg pl-5 pr-2 py-1.5 text-xs font-bold text-rose-700 focus:border-rose-500 focus:ring-1 focus:ring-rose-200 outline-none shadow-sm" placeholder="0" />
                                            </div>
                                        </div>
                                        <div>
                                            <label className="text-[9px] text-emerald-600/70 font-bold uppercase block mb-1">Abonado</label>
                                            <div className="relative">
                                                <span className="absolute left-2 top-1/2 -translate-y-1/2 text-emerald-400 text-[10px]">$</span>
                                                <CurrencyInput disabled={readOnly} value={item.payedAmount} onChange={(val) => onUpdate('payedAmount', val)} className="w-full bg-white border border-emerald-200 rounded-lg pl-5 pr-2 py-1.5 text-xs font-bold text-emerald-700 focus:border-emerald-500 focus:ring-1 focus:ring-emerald-200 outline-none shadow-sm" placeholder="0" />
                                            </div>
                                        </div>
                                    </div>
                                </>
                            )}
                            {isLinea && (
                                <>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="text-[9px] text-gray-400 font-bold uppercase block mb-1">Cupo Total Autorizado</label>
                                            <div className="relative">
                                                <span className="absolute left-2 top-1/2 -translate-y-1/2 text-gray-400 text-[10px]">$</span>
                                                <CurrencyInput disabled={readOnly} value={item.limit} onChange={(val) => onUpdate('limit', val)} className="w-full bg-white border border-gray-200 rounded-lg pl-5 pr-2 py-1.5 text-xs font-bold text-gray-600 focus:border-rose-400 outline-none" placeholder="0" />
                                            </div>
                                        </div>
                                        <div>
                                            <label className="text-[9px] text-rose-600/70 font-bold uppercase block mb-1">Deuda Total (Uso)</label>
                                            <div className="relative">
                                                <span className="absolute left-2 top-1/2 -translate-y-1/2 text-rose-400 text-[10px]">$</span>
                                                <CurrencyInput disabled={readOnly} value={item.totalDebt} onChange={(val) => onUpdate('totalDebt', val)} className="w-full bg-white border border-rose-200 rounded-lg pl-5 pr-2 py-1.5 text-xs font-bold text-rose-700 focus:border-rose-500 outline-none shadow-sm" placeholder="0" />
                                            </div>
                                        </div>
                                    </div>
                                    <div className="h-px bg-rose-100/50"></div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="text-[9px] text-gray-400 font-bold uppercase block mb-1">Disponible Real</label>
                                            <div className="w-full bg-gray-100 border border-gray-200 rounded-lg px-2 py-1.5 text-xs font-bold text-gray-500 flex items-center gap-1">
                                                <span className="text-[10px]">$</span>{formatCurrency(available).replace('$','')}
                                            </div>
                                        </div>
                                        <div>
                                            <label className="text-[9px] text-emerald-600/70 font-bold uppercase block mb-1">Abonado a la L√≠nea</label>
                                            <div className="relative">
                                                <span className="absolute left-2 top-1/2 -translate-y-1/2 text-emerald-400 text-[10px]">$</span>
                                                <CurrencyInput disabled={readOnly} value={item.payedAmount} onChange={(val) => onUpdate('payedAmount', val)} className="w-full bg-white border border-emerald-200 rounded-lg pl-5 pr-2 py-1.5 text-xs font-bold text-emerald-700 focus:border-emerald-500 outline-none shadow-sm" placeholder="0" />
                                            </div>
                                        </div>
                                    </div>
                                </>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        const SimplePieChart = ({ data }) => {
            const total = data.reduce((acc, item) => acc + item.value, 0);
            if (total === 0) return <div className="flex flex-col items-center justify-center h-48 text-gray-400"><PieChart size={32} className="mb-2 opacity-50"/><p className="text-xs">Sin datos</p></div>;
            return (
                <div className="flex flex-col items-center">
                    <div className="relative w-40 h-40 mb-4">
                        <svg viewBox="0 0 100 100" className="transform -rotate-90 w-full h-full">
                            {data.map((item, index) => {
                                const percent = item.value / total;
                                const start = 0; 
                                let cumulativePercent = 0;
                                for(let i=0; i<index; i++) cumulativePercent += data[i].value / total;
                                
                                const startPercent = cumulativePercent;
                                const endPercent = startPercent + percent;

                                const x1 = 50 + 50 * Math.cos(2 * Math.PI * startPercent);
                                const y1 = 50 + 50 * Math.sin(2 * Math.PI * startPercent);
                                const x2 = 50 + 50 * Math.cos(2 * Math.PI * endPercent);
                                const y2 = 50 + 50 * Math.sin(2 * Math.PI * endPercent);
                                const largeArc = percent > 0.5 ? 1 : 0;
                                const pathData = percent === 1 ? "M 50 50 m -50, 0 a 50,50 0 1,0 100,0 a 50,50 0 1,0 -100,0" : `M 50 50 L ${x1} ${y1} A 50 50 0 ${largeArc} 1 ${x2} ${y2} Z`;
                                return <path key={index} d={pathData} fill={item.color} stroke="white" strokeWidth="1" />;
                            })}
                        </svg>
                    </div>
                    <div className="w-full space-y-1">
                        {data.map((item, index) => (
                            <div key={index} className="flex justify-between items-center text-xs">
                                <div className="flex items-center gap-2">
                                    <span className="w-2 h-2 rounded-full" style={{ backgroundColor: item.color }}></span>
                                    <span className="text-gray-600">{item.label}</span>
                                </div>
                                <span className="font-bold text-gray-800">{formatCurrency(item.value)}</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const SettingsModal = ({ isOpen, onClose, url, onSave, currentData, onImport, onUpdateUser, userSettings, onLogout }) => {
            const [tempUrl, setTempUrl] = useState(url);
            const [tempName, setTempName] = useState(userSettings?.name || '');
            
            useEffect(() => { 
                setTempUrl(url); 
                setTempName(userSettings?.name || ''); 
            }, [url, isOpen, userSettings]);

            if (!isOpen) return null;

            const handleExport = () => {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(currentData));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", `backup_finanzas_${new Date().toISOString().split('T')[0]}.json`);
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            };

            const handleUserUpdate = (key, val) => { 
                onUpdateUser(key, val); 
                if(key === 'name') setTempName(val); 
            };

            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm fade-in">
                    <div className="bg-white rounded-2xl w-full max-w-sm shadow-2xl overflow-hidden max-h-[90vh] overflow-y-auto">
                        <div className="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                            <h3 className="font-bold text-gray-800 flex items-center gap-2"><Settings size={18}/> Configuraci√≥n</h3>
                            <button onClick={onClose}><X size={20} className="text-gray-400 hover:text-gray-600"/></button>
                        </div>
                        <div className="p-4 space-y-6">
                            <div className="space-y-4">
                                <h4 className="text-xs font-bold text-gray-400 uppercase flex items-center gap-1"><UserCircle size={12}/> Personalizaci√≥n</h4>
                                <div className="space-y-2">
                                    <label className="text-xs text-gray-500 font-bold">Tu Nombre</label>
                                    <input 
                                        className="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm font-medium focus:outline-none focus:border-indigo-500" 
                                        placeholder="Ej. Juan P√©rez" 
                                        value={tempName} 
                                        onChange={(e) => handleUserUpdate('name', e.target.value)} 
                                    />
                                </div>
                                <div className="space-y-2">
                                    <label className="text-xs text-gray-500 font-bold flex items-center gap-1"><Palette size={12}/> Color Principal</label>
                                    <div className="grid grid-cols-6 gap-2">
                                        {Object.entries(THEMES).map(([key, theme]) => (
                                            <button 
                                                key={key} 
                                                onClick={() => handleUserUpdate('theme', key)} 
                                                className={`w-8 h-8 rounded-full ${theme.bg} transition-transform active:scale-90 flex items-center justify-center ring-offset-1 ${userSettings?.theme === key ? 'ring-2 ring-gray-400 scale-110' : ''}`} 
                                                title={theme.name}
                                            >
                                                {userSettings?.theme === key && <Check size={14} className="text-white"/>}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                            <div className="h-px bg-gray-100"></div>
                            <div className="space-y-2">
                                <label className="text-xs font-bold text-gray-400 uppercase flex items-center gap-1"><Cloud size={12}/> Google Apps Script URL</label>
                                <input 
                                    className="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-xs focus:outline-none focus:border-indigo-500" 
                                    placeholder="https://script.google.com/..." 
                                    value={tempUrl} 
                                    onChange={(e) => setTempUrl(e.target.value)} 
                                />
                                <button onClick={() => { onSave(tempUrl); onClose(); }} className="w-full bg-indigo-600 text-white py-2 rounded-lg text-xs font-bold hover:bg-indigo-700">Guardar URL</button>
                            </div>
                            <div className="space-y-3 pt-4 border-t border-gray-100">
                                <h4 className="text-xs font-bold text-gray-400 uppercase">Gesti√≥n de Datos</h4>
                                <div className="grid grid-cols-2 gap-2">
                                    <button onClick={handleExport} className="flex items-center justify-center gap-2 bg-emerald-50 text-emerald-600 py-2 rounded-lg text-xs font-bold hover:bg-emerald-100 border border-emerald-100">
                                        <Download size={14}/> Exportar JSON
                                    </button>
                                    <label className="flex items-center justify-center gap-2 bg-blue-50 text-blue-600 py-2 rounded-lg text-xs font-bold hover:bg-blue-100 border border-blue-100 cursor-pointer">
                                        <Upload size={14}/> Importar JSON
                                        <input type="file" className="hidden" accept=".json" onChange={(e) => { 
                                            const file = e.target.files[0]; 
                                            if(!file) return; 
                                            const reader = new FileReader(); 
                                            reader.onload = (ev) => { 
                                                try { 
                                                    const parsed = JSON.parse(ev.target.result); 
                                                    if(window.confirm('¬øRestaurar respaldo? Se perder√°n los cambios actuales.')) { 
                                                        onImport(parsed); 
                                                        onClose(); 
                                                    } 
                                                } catch(ex) { alert('Archivo inv√°lido'); } 
                                            }; 
                                            reader.readAsText(file); 
                                        }}/>
                                    </label>
                                </div>
                            </div>
                            
                            {/* Cerrar Sesi√≥n */}
                            <button onClick={() => { if(window.confirm('¬øCerrar sesi√≥n?')) { onLogout(); onClose(); }}} className="w-full py-2 text-red-500 text-xs font-bold flex items-center justify-center gap-2 border border-red-100 rounded-lg hover:bg-red-50">
                                <Logout size={14}/> Cerrar Sesi√≥n
                            </button>
                            
                            <div className="pt-2 text-center">
                                <p className="text-[10px] text-gray-400">Versi√≥n 2.9.1 (Full Expanded)</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- INICIALIZACI√ìN ---
        const INITIAL_DATA = { 
            isClosed: false, 
            userSettings: { name: '', theme: 'indigo', appMode: null }, 
            income: 0, 
            extraIncome: 0, 
            businessIncome: { 
                configSet: false, 
                types: { products: false, workshops: false, supplies: false }, 
                items: { products: [], workshops: [], supplies: [] } 
            }, 
            supermarket: { budget: 0, items: [], lists: [] }, 
            hogar: [], 
            subscriptions: [], 
            creditCards: [], 
            customModules: [], 
            savings: [], 
            loansGiven: [], 
            streetFood: [] 
        };

        // --- APP MAIN ---
        const App = () => {
            const today = new Date();
            const [viewDate, setViewDate] = useState({ month: today.getMonth(), year: today.getFullYear() });
            const [currentView, setCurrentView] = useState('dashboard');
            const [chartTab, setChartTab] = useState('general');
            const [data, setData] = useState(INITIAL_DATA);
            const [isLoaded, setIsLoaded] = useState(false);
            const [sheetUrl, setSheetUrl] = useState('');
            const [syncStatus, setSyncStatus] = useState('idle');
            const [showSettings, setShowSettings] = useState(false);
            const [auth, setAuth] = useState({ isAuthenticated: false, user: null });
            const [activeListId, setActiveListId] = useState(null);
            
            // New Inputs
            const [newProduct, setNewProduct] = useState({ name: '', price: '' });
            const [newStreetItem, setNewStreetItem] = useState({ name: '', amount: '' });
            const [newMarketItem, setNewMarketItem] = useState({ name: '', amount: '' });
            const [newHogarItem, setNewHogarItem] = useState({ name: '', amount: '' });
            const [newSubscriptionItem, setNewSubscriptionItem] = useState({ name: '', amount: '' });
            const [newSavingsItem, setNewSavingsItem] = useState({ name: '', amount: '' });
            const [newLoanItem, setNewLoanItem] = useState({ name: '', amount: '' });
            const [newBankName, setNewBankName] = useState('');
            const [newBankTypes, setNewBankTypes] = useState({ pesos: true, dolares: true, linea: true });
            const [isAddingBank, setIsAddingBank] = useState(false);
            const [customModuleInputs, setCustomModuleInputs] = useState({});
            
            // Inputs for Business
            const [newBizProduct, setNewBizProduct] = useState({ name: '', amount: '' });
            const [newBizSupply, setNewBizSupply] = useState({ name: '', amount: '' });
            const [newBizWorkshop, setNewBizWorkshop] = useState({ name: '', price: '', count: '' });

            const debounceRef = useRef(null);
            const getStorageKey = (m, y) => `finance-v18-${y}-${m}`;

            // --- Handlers & Effects ---
            const handleLogin = (user) => { 
                const session = { isAuthenticated: true, user }; 
                setAuth(session); 
                localStorage.setItem('finance_user_session', JSON.stringify(session)); 
            };

            const handleNameSubmit = (name) => { 
                if(!name.trim()) return; 
                const newData = { 
                    ...data, 
                    userSettings: { ...data.userSettings, name: name } 
                }; 
                setData(newData); 
                const key = getStorageKey(viewDate.month, viewDate.year); 
                localStorage.setItem(key, JSON.stringify(newData)); 
            };

            const handleLogout = () => { 
                localStorage.removeItem('finance_user_session'); 
                setAuth({ isAuthenticated: false, user: null }); 
                window.location.reload(); 
            };

            const handleModeSelect = (mode) => { 
                const newData = { 
                    ...data, 
                    userSettings: { ...data.userSettings, appMode: mode } 
                }; 
                setData(newData); 
                const key = getStorageKey(viewDate.month, viewDate.year); 
                localStorage.setItem(key, JSON.stringify(newData)); 
            };
            
            const getLabels = () => {
                const mode = data.userSettings?.appMode || 'personal';
                return mode === 'business' ? { 
                    mode: 'business', 
                    hogarTitle: 'Mi Negocio', 
                    hogarIcon: Store, 
                    superTitle: 'Compras / Insumos', 
                    hogarItemsDef: 'Gastos Operativos', 
                    listTitle: 'Listas de Compras' 
                } : { 
                    mode: 'personal', 
                    hogarTitle: 'Hogar', 
                    hogarIcon: Home, 
                    superTitle: 'Supermercado', 
                    hogarItemsDef: 'Gastos del Hogar', 
                    listTitle: 'Listas de Mercado' 
                };
            };
            const LABELS = getLabels();
            const currentTheme = THEMES[data.userSettings?.theme] || THEMES.indigo;

            // Handlers
            const toggleMonthStatus = () => { 
                if(window.confirm(`¬øEst√°s seguro de ${data.isClosed ? "abrir" : "cerrar"} el mes?`)) 
                    setData({ ...data, isClosed: !data.isClosed }); 
            };

            const resetMonth = () => { 
                if (data.isClosed) return; 
                if(!window.confirm("¬øReiniciar valores?")) return; 
                
                const zeroList = (list) => list.map(i => ({...i, amount: 0, paid: false})); 
                const zeroCards = (list) => list.map(i => ({...i, monthlyQuota: 0, payedAmount: 0, status: 'pending'})); 
                const zeroModules = (modules) => modules.map(m => ({ ...m, items: m.items.map(i => ({...i, amount: 0, paid: false})) })); 
                const zeroBiz = { ...data.businessIncome, items: { products: [], workshops: [], supplies: [] } };
                
                setData({ 
                    ...data, 
                    income: data.income, 
                    extraIncome: 0, 
                    businessIncome: zeroBiz,
                    supermarket: { budget: data.supermarket?.budget || 0, items: [], lists: [] }, 
                    hogar: zeroList(data.hogar), 
                    subscriptions: zeroList(data.subscriptions), 
                    creditCards: zeroCards(data.creditCards), 
                    customModules: zeroModules(data.customModules), 
                    savings: zeroList(data.savings || []), 
                    loansGiven: [], 
                    streetFood: [] 
                }); 
            };

            const updateList = (k, fn) => !data.isClosed && setData({...data, [k]: fn(data[k] || [])});
            
            const updateBizList = (type, fn) => {
                if (data.isClosed) return;
                setData({
                    ...data,
                    businessIncome: {
                        ...data.businessIncome,
                        items: {
                            ...data.businessIncome.items,
                            [type]: fn(data.businessIncome.items[type] || [])
                        }
                    }
                });
            };

            const addBank = () => { 
                if (!newBankName.trim()) return; 
                const ts = Date.now(); 
                const newCards = []; 
                if (newBankTypes.pesos) newCards.push({ id: `tc-${ts}-1`, bank: newBankName, name: 'TC Pesos', type: 'tc_pesos', totalDebt: 0, monthlyQuota: 0, payedAmount: 0, status: 'pending', cutoffDate: '' }); 
                if (newBankTypes.dolares) newCards.push({ id: `tc-${ts}-2`, bank: newBankName, name: 'TC D√≥lares', type: 'tc_dolares', totalDebt: 0, monthlyQuota: 0, payedAmount: 0, status: 'pending', cutoffDate: '' }); 
                if (newBankTypes.linea) newCards.push({ id: `tc-${ts}-3`, bank: newBankName, name: 'L√≠nea Cr√©dito', type: 'linea', totalDebt: 0, limit: 0, payedAmount: 0, status: 'pending' }); 
                updateList('creditCards', list => [...list, ...newCards]); 
                setNewBankName(''); 
                setIsAddingBank(false); 
            };

            const updateUser = (key, val) => { setData(prev => ({ ...prev, userSettings: { ...prev.userSettings, [key]: val } })); };

            useEffect(() => {
                const sessionStr = localStorage.getItem('finance_user_session'); 
                if(sessionStr) try { setAuth(JSON.parse(sessionStr)); } catch(e) {}
                
                const savedUrl = localStorage.getItem('google_sheet_script_url'); 
                if(savedUrl) setSheetUrl(savedUrl);
                
                const key = getStorageKey(viewDate.month, viewDate.year); 
                const savedData = localStorage.getItem(key);
                
                if(savedData) { 
                    try { 
                        const parsed = JSON.parse(savedData); 
                        setData({ ...INITIAL_DATA, ...parsed, userSettings: parsed.userSettings || INITIAL_DATA.userSettings }); 
                    } catch(e) { setData(INITIAL_DATA); } 
                } else { 
                    const resetItem = (item) => ({ ...item, amount: 0, paid: false });
                    const template = { 
                        ...INITIAL_DATA, 
                        userSettings: data.userSettings, 
                        income: data.income, 
                        businessIncome: { 
                            ...data.businessIncome, 
                            items: { products: [], workshops: [], supplies: [] } 
                        }, 
                        hogar: (data.hogar || []).map(resetItem), 
                        subscriptions: (data.subscriptions || []).map(resetItem), 
                        customModules: (data.customModules || []).map(m => ({ ...m, items: m.items.map(resetItem) })), 
                        savings: (data.savings || []).map(resetItem), 
                        creditCards: (data.creditCards || []).map(c => ({ ...c, monthlyQuota: 0, payedAmount: 0, status: 'pending' })), 
                        supermarket: { budget: data.supermarket?.budget || 0, items: [], lists: [] }, 
                        streetFood: [], 
                        loansGiven: [] 
                    };
                    setData(template);
                }
                setIsLoaded(true);
            }, [viewDate]);

            useEffect(() => { 
                if(isLoaded && auth.isAuthenticated) { 
                    const key = getStorageKey(viewDate.month, viewDate.year); 
                    localStorage.setItem(key, JSON.stringify(data)); 
                    if(sheetUrl) { 
                        setSyncStatus('syncing'); 
                        if(debounceRef.current) clearTimeout(debounceRef.current); 
                        debounceRef.current = setTimeout(async () => { 
                            try { 
                                await fetch(sheetUrl, { 
                                    method: 'POST', 
                                    mode: 'no-cors', 
                                    headers: { 'Content-Type': 'application/json' }, 
                                    body: JSON.stringify({ month: MONTHS[viewDate.month], year: viewDate.year, ...data }) 
                                }); 
                                setSyncStatus('success'); 
                                setTimeout(() => setSyncStatus('idle'), 2000); 
                            } catch(e) { setSyncStatus('error'); } 
                        }, 3000); 
                    } 
                } 
            }, [data, isLoaded, auth]);

            if (!isLoaded) return null;
            if (!auth.isAuthenticated) return <LoginScreen onLogin={handleLogin} />;
            if (!data.userSettings?.name) return <NameSetupScreen onSaveName={handleNameSubmit} />;
            if (!data.userSettings?.appMode) return <OnboardingScreen onSelectMode={handleModeSelect} />;

            const isReadOnly = data.isClosed;
            const calcTotal = (l) => (l || []).reduce((a,b) => a + (Number(b.amount)||0), 0);
            const calcPaid = (l) => (l || []).filter(i => i.paid).reduce((a,b) => a + (Number(b.amount)||0), 0);
            
            // C√°lculos
            const bizProductsTotal = (data.businessIncome?.items?.products || []).reduce((acc, i) => acc + (Number(i.amount)||0), 0);
            const bizSuppliesTotal = (data.businessIncome?.items?.supplies || []).reduce((acc, i) => acc + (Number(i.amount)||0), 0);
            const bizWorkshopsTotal = (data.businessIncome?.items?.workshops || []).reduce((acc, i) => acc + ((Number(i.pricePerPerson)||0) * (Number(i.count)||0)), 0);
            const totalBusinessIncome = bizProductsTotal + bizSuppliesTotal + bizWorkshopsTotal;

            const marketSimpleSpent = calcTotal(data.supermarket?.items);
            const marketListsSpent = (data.supermarket?.lists || []).reduce((acc, list) => acc + (list.items || []).filter(i => i.checked).reduce((sum, item) => sum + (Number(item.price) || 0), 0), 0);
            const marketSpent = marketSimpleSpent + marketListsSpent;
            const customTotal = (data.customModules||[]).reduce((a,b) => a + calcTotal(b.items), 0);
            const customPaid = (data.customModules||[]).reduce((a,b) => a + calcPaid(b.items), 0);
            
            const creditCalculation = (data.creditCards||[]).reduce((acc, item) => {
                if(item.status === 'no_debt') return acc;
                let fullAmount = 0, paidAmount = Number(item.payedAmount) || 0;
                if (item.type === 'linea') { 
                    fullAmount = Number(item.totalDebt) || 0; 
                } else if (item.type === 'tc_dolares') { 
                    const quota = Number(item.monthlyQuota) || 0; 
                    fullAmount = quota * USD_VALUE; 
                    paidAmount = paidAmount * USD_VALUE; 
                } else { 
                    fullAmount = Number(item.monthlyQuota) || 0; 
                }
                return { total: acc.total + fullAmount, paid: acc.paid + paidAmount };
            }, { total: 0, paid: 0 });

            const totals = { 
                hogar: calcTotal(data.hogar), 
                hogarPaid: calcPaid(data.hogar), 
                subscriptions: calcTotal(data.subscriptions), 
                subscriptionsPaid: calcPaid(data.subscriptions), 
                creditCards: creditCalculation.total, 
                creditCardsPaid: creditCalculation.paid, 
                supermarket: marketSpent, 
                savings: calcTotal(data.savings), 
                savingsPaid: calcPaid(data.savings), 
                loansGiven: calcTotal(data.loansGiven), 
                loansGivenPaid: calcPaid(data.loansGiven), 
                street: calcTotal(data.streetFood), 
                streetPaid: calcPaid(data.streetFood), 
                custom: customTotal 
            };
            
            const hogarPending = (totals.hogar - totals.hogarPaid) + (totals.subscriptions - totals.subscriptionsPaid) + (totals.street - totals.streetPaid) + (customTotal - customPaid);
            const creditPending = Math.max(0, totals.creditCards - totals.creditCardsPaid);
            const totalPendingToPay = hogarPending + creditPending;
            const grandTotalExpenses = totals.hogar + totals.subscriptions + totals.street + totals.custom + totals.creditCards + totals.supermarket;
            const totalAhorros = totals.savings + totals.loansGiven;
            const totalOutflows = grandTotalExpenses + totalAhorros;
            const totalPaidOutflows = totals.hogarPaid + totals.subscriptionsPaid + totals.streetPaid + customPaid + totals.creditCardsPaid + totals.savingsPaid + totals.loansGivenPaid + marketSpent;
            
            const baseIncome = data.userSettings?.appMode === 'business' ? totalBusinessIncome : (Number(data.income) || 0);
            const totalIncome = baseIncome + (Number(data.extraIncome) || 0);
            
            const projectedBalance = totalIncome - totalOutflows;
            const currentCashBalance = totalIncome - totalPaidOutflows;

            const expenseDistribution = [
                { label: LABELS.hogarTitle, value: totals.hogar + totals.subscriptions + totals.custom + totals.street, color: '#10B981' }, 
                { label: LABELS.superTitle, value: totals.supermarket, color: '#6366F1' }, 
                { label: 'Tarjetas', value: totals.creditCards, color: '#F43F5E' }
            ].filter(i => i.value > 0);

            const creditCardUsage = (data.creditCards || []).map(card => ({ 
                label: card.name, 
                total: card.type === 'linea' ? (Number(card.totalDebt)||0) : (Number(card.monthlyQuota)||0), 
                paid: Number(card.payedAmount) || 0 
            })).filter(c => c.total > 0);

            const updateCustomModules = (fn) => !isReadOnly && setData({...data, customModules: fn(data.customModules || [])});
            const updateCustomModuleName = (id, name) => updateCustomModules(list => list.map(m => m.id === id ? { ...m, name } : m));
            const togglePaid = (k, id) => updateList(k, l => l.map(i => i.id === id ? {...i, paid: !i.paid} : i));
            const updateAmount = (k, id, v) => updateList(k, l => l.map(i => i.id === id ? {...i, amount: v} : i));
            const updateName = (k, id, v) => updateList(k, l => l.map(i => i.id === id ? {...i, name: v} : i));
            const delItem = (k, id) => updateList(k, l => l.filter(i => i.id !== id));
            
            const addItem = (k, state, setState) => { 
                if(!state.name || !state.amount || isReadOnly) return; 
                updateList(k, l => [...l, {id: Date.now(), name: state.name, amount: Number(state.amount), paid: false}]); 
                setState({name:'', amount:''}); 
            };
            
            const updateCard = (id, field, val) => { 
                if (isReadOnly) return; 
                updateList('creditCards', list => list.map(c => c.id === id ? { ...c, [field]: val } : c)); 
            };
            
            const uniqueBanks = [...new Set((data.creditCards || []).map(item => item.bank))];
            const marketBudget = Number(data.supermarket?.budget) || 0;
            const marketRatio = marketBudget > 0 ? (marketSpent / marketBudget) : 0;
            
            const handleCreateList = () => { 
                const newList = { id: Date.now(), name: 'Nueva Lista', items: [] }; 
                setData({ ...data, supermarket: { ...data.supermarket, lists: [...(data.supermarket.lists || []), newList] } }); 
                setActiveListId(newList.id); 
            };
            
            const activeList = activeListId ? (data.supermarket?.lists || []).find(l => l.id === activeListId) : null;
            
            const updateActiveList = (newListData) => { 
                const updatedLists = data.supermarket.lists.map(l => l.id === activeListId ? newListData : l); 
                setData({ ...data, supermarket: { ...data.supermarket, lists: updatedLists } }); 
            };
            
            const handleFinishList = (targetList) => { 
                if (!targetList) return; 
                const checkedItems = targetList.items.filter(i => i.checked); 
                if (checkedItems.length === 0) return; 
                
                const totalSpent = checkedItems.reduce((acc, i) => acc + (Number(i.price) || 0), 0); 
                const hasMissingPrices = checkedItems.some(i => !i.price || Number(i.price) === 0); 
                
                if (hasMissingPrices) { 
                    if (!window.confirm(`Valores inexactos. ¬øSeguro?`)) return; 
                } else { 
                    if (!window.confirm(`¬øRegistrar compra por ${formatCurrency(totalSpent)}?`)) return; 
                } 
                
                const newItem = { id: Date.now(), name: targetList.name, amount: totalSpent, inexact: hasMissingPrices }; 
                const newLists = data.supermarket.lists.filter(l => l.id !== targetList.id); 
                const newHistory = [...(data.supermarket.items || []), newItem]; 
                
                setData({ ...data, supermarket: { ...data.supermarket, lists: newLists, items: newHistory } }); 
            };
            
            const itemsWithoutPrice = activeList ? activeList.items.filter(i => !i.price || Number(i.price) === 0).length : 0;
            const activeListTotal = activeList ? activeList.items.reduce((acc, i) => acc + (Number(i.price) || 0), 0) : 0;

            // --- RENDER ---
            return (
                <div className="flex flex-col md:flex-row min-h-screen bg-gray-50/50">
                    <SettingsModal isOpen={showSettings} onClose={() => setShowSettings(false)} url={sheetUrl} onSave={(u) => { setSheetUrl(u); localStorage.setItem('google_sheet_script_url', u); }} currentData={data} onImport={setData} onUpdateUser={updateUser} userSettings={data.userSettings} onLogout={handleLogout} />
                    
                    <DesktopSidebar currentView={currentView} onChangeView={(view) => { setCurrentView(view); setActiveListId(null); }} labels={LABELS} theme={currentTheme} onSettings={() => setShowSettings(true)} />

                    <div className="flex-1 flex flex-col h-screen overflow-hidden">
                        {/* Mobile Header / Desktop Topbar */}
                        <header className={`px-4 py-3 text-white shadow-lg transition-colors flex shrink-0 justify-between items-center z-40 ${isReadOnly ? 'bg-gray-800' : currentTheme.bg} md:bg-white md:text-gray-800 md:shadow-sm md:border-b md:border-gray-100 md:py-4`}>
                            <div className="flex items-center gap-2 md:hidden">
                                {currentView !== 'dashboard' && <button onClick={() => { if(activeListId) setActiveListId(null); else setCurrentView('dashboard'); }}><ArrowLeft/></button>}
                                <h1 className="font-bold text-lg">{activeListId ? 'Editar Lista' : currentView === 'dashboard' ? (data.userSettings?.name ? `Hola, ${data.userSettings.name.split(' ')[0]}` : 'Mis Finanzas') : LABELS[currentView === 'hogar' ? 'hogarTitle' : currentView === 'supermercado' ? 'superTitle' : ''] || currentView.charAt(0).toUpperCase() + currentView.slice(1)}</h1>
                            </div>
                            <div className="hidden md:flex flex-col">
                                <h1 className="text-xl font-bold text-gray-800">{activeListId ? `Editando: ${activeList?.name}` : currentView === 'dashboard' ? `Hola, ${data.userSettings?.name || 'Usuario'}` : currentView === 'hogar' ? LABELS.hogarTitle : currentView === 'supermercado' ? LABELS.superTitle : currentView.charAt(0).toUpperCase() + currentView.slice(1)}</h1>
                                <p className="text-xs text-gray-400 font-medium">Control financiero {LABELS.mode === 'business' ? 'corporativo' : 'personal'}</p>
                            </div>
                            
                            <div className="flex gap-2 items-center">
                                <div className="flex items-center gap-2 bg-black/10 md:bg-gray-100 rounded-lg p-1 mr-2">
                                    <div className="relative"><select value={viewDate.month} onChange={e => setViewDate({...viewDate, month: parseInt(e.target.value)})} className="bg-transparent rounded px-2 py-1 text-sm appearance-none pr-6 font-medium focus:outline-none md:text-gray-700">{MONTHS.map((m,i)=><option key={i} value={i} className="text-black">{m}</option>)}</select><ChevronDown className="absolute right-1 top-2 pointer-events-none opacity-50" size={14}/></div>
                                    <div className="w-px h-4 bg-white/20 md:bg-gray-300"></div>
                                    <div className="relative"><select value={viewDate.year} onChange={e => setViewDate({...viewDate, year: parseInt(e.target.value)})} className="bg-transparent rounded px-2 py-1 text-sm appearance-none pr-6 font-medium focus:outline-none md:text-gray-700">{[2024, 2025, 2026].map(y=><option key={y} value={y} className="text-black">{y}</option>)}</select><ChevronDown className="absolute right-1 top-2 pointer-events-none opacity-50" size={14}/></div>
                                </div>
                                {!isReadOnly && <button onClick={resetMonth} className="p-2 rounded-full hover:bg-white/20 md:hover:bg-gray-100 transition" title="Reiniciar mes"><RotateCcw size={18} className="md:text-gray-500"/></button>}
                                <button onClick={() => setShowSettings(true)} className="md:hidden"><Settings size={18}/></button>
                                <button onClick={toggleMonthStatus} className={`flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-bold transition ${isReadOnly ? 'bg-gray-700 text-gray-300' : 'bg-white/20 hover:bg-white/30 md:bg-indigo-50 md:text-indigo-600 md:hover:bg-indigo-100'}`}>{isReadOnly ? <Lock size={12}/> : <Unlock size={12}/>}{isReadOnly ? 'CERRADO' : 'Cerrar Mes'}</button>
                            </div>
                        </header>

                        <div className="flex-1 overflow-y-auto p-4 md:p-8">
                            <div className="max-w-6xl mx-auto space-y-6 fade-in">
                                {currentView === 'dashboard' && (
                                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                        {/* Summary Card */}
                                        <div className={`p-6 rounded-3xl shadow-sm relative overflow-hidden lg:col-span-2 ${isReadOnly ? 'bg-gray-200' : 'bg-white border border-gray-100'}`}>
                                            <div className={`absolute top-0 right-0 p-6 opacity-5 ${currentTheme.text}`}><DollarSign size={140}/></div>
                                            <div className="grid md:grid-cols-2 gap-8 relative z-10">
                                                <div className="space-y-4">
                                                    <div><label className="text-xs font-bold text-gray-400 uppercase">Ingresos Totales</label><div className="flex items-center gap-2 text-3xl font-bold text-gray-800"><span className="text-green-500">$</span><CurrencyInput disabled={isReadOnly || data.userSettings?.appMode === 'business'} value={data.userSettings?.appMode === 'business' ? totalBusinessIncome : data.income} onChange={val => setData({...data, income: val})} className={`bg-transparent w-full outline-none ${data.userSettings?.appMode === 'business' ? 'text-gray-600' : ''}`} placeholder="0"/>{data.userSettings?.appMode === 'business' && <span className="text-xs text-gray-400 font-normal">(Auto)</span>}</div></div>
                                                    <div className="pt-2 border-t border-dashed border-gray-100"><label className="text-xs font-bold text-gray-400 uppercase flex items-center gap-1"><Banknote size={12}/> Dinero Adicional</label><div className="flex items-center gap-2 text-xl font-bold text-gray-600"><span className="text-green-500/70">$</span><CurrencyInput disabled={isReadOnly} value={data.extraIncome || ''} onChange={val => setData({...data, extraIncome: val})} className="bg-transparent w-full outline-none" placeholder="0"/></div></div>
                                                </div>
                                                <div className="space-y-4">
                                                    <div><p className="text-gray-400 font-bold text-xs uppercase">Presupuesto de Gastos</p><p className="text-gray-800 font-bold text-2xl">{formatCurrency(totalOutflows)}</p><div className="flex flex-col gap-1 mt-1"><p className="text-xs font-bold text-emerald-600 bg-emerald-50 w-fit px-2 py-0.5 rounded">Ejecutado: {formatCurrency(totalPaidOutflows)}</p><p className="text-xs font-bold text-orange-600 bg-orange-50 w-fit px-2 py-0.5 rounded">Por Pagar: {formatCurrency(totalPendingToPay)}</p></div></div>
                                                    <div><p className="text-gray-400 font-bold text-xs uppercase">Reservas</p><p className="text-gray-800 font-bold text-2xl">{formatCurrency(totalAhorros)}</p></div>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Balances Card */}
                                        <div className="lg:col-span-1 space-y-4">
                                            <div className="bg-emerald-50 rounded-3xl p-6 border border-emerald-100 h-full flex flex-col justify-center"><span className="text-xs font-bold text-emerald-600/70 uppercase block mb-2 flex items-center gap-1"><Wallet size={14}/> Saldo Disponible Hoy</span><span className={`text-3xl font-bold leading-none ${currentCashBalance >= 0 ? 'text-emerald-600' : 'text-red-500'}`}>{formatCurrency(currentCashBalance)}</span></div>
                                            <div className="bg-blue-50 rounded-3xl p-6 border border-blue-100 h-full flex flex-col justify-center text-right"><span className="text-xs font-bold text-blue-600/70 uppercase block mb-2">Saldo Final Estimado</span><span className={`text-3xl font-bold leading-none ${projectedBalance >= 0 ? 'text-blue-600' : 'text-red-500'}`}>{formatCurrency(projectedBalance)}</span></div>
                                        </div>

                                        {/* Mobile Navigation Buttons (Hidden on Desktop) */}
                                        <div className="md:hidden grid gap-3 lg:col-span-3">
                                            {data.userSettings?.appMode === 'business' && <CategoryButton title="Ingresos" icon={TrendingUp} total={totalBusinessIncome} color={{bg:'bg-emerald-600', text:'text-white'}} onClick={()=>setCurrentView('ingresos')} subtitle="Ventas y Servicios"/>}
                                            <CategoryButton title={LABELS.hogarTitle} icon={LABELS.hogarIcon} total={hogarPending} color={{bg:'bg-emerald-100', text:'text-emerald-600'}} onClick={()=>setCurrentView('hogar')} />
                                            <CategoryButton title="Tarjetas" icon={CreditCard} total={totals.creditCards} color={{bg:'bg-rose-100', text:'text-rose-600'}} onClick={()=>setCurrentView('tarjetas')} />
                                            <CategoryButton title={LABELS.superTitle} icon={ShoppingCart} total={totals.supermarket} color={{bg:'bg-indigo-100', text:'text-indigo-600'}} onClick={()=>setCurrentView('supermercado')} />
                                            <CategoryButton title="Reservas" icon={PiggyBank} total={totalAhorros} color={{bg:'bg-orange-100', text:'text-orange-600'}} onClick={()=>setCurrentView('ahorros')} />
                                            <CategoryButton title="Gr√°ficos" icon={BarChart3} total={0} showAmount={false} subtitle="An√°lisis y estad√≠sticas" color={{bg:'bg-blue-100', text:'text-blue-600'}} onClick={()=>setCurrentView('graficos')} />
                                        </div>

                                        {/* Desktop Widgets (Visible only on Desktop) */}
                                        <div className="hidden md:block lg:col-span-3">
                                            <div className="bg-white p-6 rounded-3xl border border-gray-100 shadow-sm">
                                                <h3 className="font-bold text-gray-800 mb-4 flex items-center gap-2"><PieChart size={20}/> Distribuci√≥n R√°pida</h3>
                                                <div className="flex gap-8 justify-around">
                                                    <div className="w-1/3"><SimplePieChart data={expenseDistribution} /></div>
                                                    <div className="flex-1 grid grid-cols-2 gap-4">
                                                        {creditCardUsage.slice(0, 4).map((c, i) => <div key={i} className="bg-gray-50 p-3 rounded-xl"><p className="text-xs text-gray-500 font-bold truncate">{c.label}</p><ProgressBar label="" value={c.paid} total={c.total} colorClass="bg-rose-500"/></div>)}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {currentView === 'ingresos' && data.userSettings?.appMode === 'business' && (
                                    <div className="max-w-[720px] mx-auto space-y-6">
                                        {!data.businessIncome?.configSet ? (
                                            <div className="flex justify-center">
                                                <div className="bg-white p-8 rounded-3xl shadow-lg border border-emerald-100 max-w-md w-full">
                                                    <div className="flex justify-center mb-6"><div className="p-4 bg-emerald-100 rounded-full text-emerald-600"><TrendingUp size={40}/></div></div>
                                                    <h2 className="text-2xl font-bold text-center text-gray-800 mb-2">Configura tus Ingresos</h2>
                                                    <p className="text-center text-gray-500 text-sm mb-8">¬øQu√© tipo de ingresos recibes?</p>
                                                    <div className="space-y-4 mb-8">
                                                        {[{ id: 'products', label: 'Venta de Productos', icon: Package }, { id: 'workshops', label: 'Talleres / Capacitaciones', icon: Presentation }, { id: 'supplies', label: 'Venta de Insumos', icon: Store }].map(opt => (
                                                            <label key={opt.id} className={`flex items-center gap-4 p-4 rounded-xl border cursor-pointer transition-all ${data.businessIncome.types[opt.id] ? 'bg-emerald-50 border-emerald-500 text-emerald-800 shadow-sm' : 'bg-gray-50 border-gray-200 text-gray-600'}`}>
                                                                <input type="checkbox" className="w-5 h-5 accent-emerald-600" checked={data.businessIncome.types[opt.id]} onChange={(e) => setData({ ...data, businessIncome: { ...data.businessIncome, types: { ...data.businessIncome.types, [opt.id]: e.target.checked } } })} />
                                                                <opt.icon size={24}/>
                                                                <span className="font-bold">{opt.label}</span>
                                                            </label>
                                                        ))}
                                                    </div>
                                                    <button onClick={() => setData({...data, businessIncome: { ...data.businessIncome, configSet: true }})} disabled={!Object.values(data.businessIncome.types).some(Boolean)} className="w-full bg-emerald-600 text-white font-bold py-4 rounded-xl hover:bg-emerald-700 disabled:opacity-50 transition-all shadow-lg shadow-emerald-200">Comenzar</button>
                                                </div>
                                            </div>
                                        ) : (
                                            <>
                                                <div className="mb-4 flex justify-between items-end bg-emerald-600 rounded-[2rem] p-8 text-white shadow-lg shadow-emerald-200 relative overflow-hidden">
                                                    <div className="relative z-10"><p className="text-emerald-100 font-bold uppercase mb-1">Ingresos Totales del Mes</p><p className="text-5xl font-extrabold tracking-tight">{formatCurrency(totalBusinessIncome)}</p></div>
                                                    <div className="relative z-10">{!isReadOnly && <button onClick={() => setData({...data, businessIncome: {...data.businessIncome, configSet: false}})} className="text-xs text-emerald-200 hover:text-white bg-black/20 px-3 py-1.5 rounded-full flex items-center gap-1 transition-colors"><Settings size={12}/> Configurar</button>}</div>
                                                    <div className="absolute right-0 bottom-0 p-4 opacity-10"><TrendingUp size={200}/></div>
                                                </div>
                                                
                                                {data.businessIncome.types.products && (
                                                    <SectionCard title="Venta de Productos" icon={Package} total={bizProductsTotal} colorClass="bg-white" headerClass="bg-blue-50 text-blue-800" readOnly={isReadOnly}>
                                                        {data.businessIncome.items.products.map(i => (
                                                            <div key={i.id} className="flex justify-between items-center py-2 border-b border-gray-50 last:border-0">
                                                                <span className="text-sm font-medium text-gray-700">{i.name}</span>
                                                                <div className="flex items-center gap-2">
                                                                    <span className="font-bold text-gray-800">{formatCurrency(i.amount)}</span>
                                                                    {!isReadOnly && <button onClick={() => updateBizList('products', l => l.filter(x => x.id !== i.id))} className="text-gray-300 hover:text-red-500"><Trash2 size={14}/></button>}
                                                                </div>
                                                            </div>
                                                        ))}
                                                        {!isReadOnly && <AddItemRow placeholder="Producto..." name={newBizProduct.name} amount={newBizProduct.amount} onNameChange={e=>setNewBizProduct({...newBizProduct, name:e.target.value})} onAmountChange={val=>setNewBizProduct({...newBizProduct, amount:val})} onAdd={() => { if(!newBizProduct.name || !newBizProduct.amount) return; updateBizList('products', l => [...l, {id: Date.now(), name: newBizProduct.name, amount: Number(newBizProduct.amount)}]); setNewBizProduct({name:'', amount:''}); }} />}
                                                    </SectionCard>
                                                )}

                                                {data.businessIncome.types.workshops && (
                                                    <SectionCard title="Talleres / Capacitaciones" icon={Presentation} total={bizWorkshopsTotal} colorClass="bg-white" headerClass="bg-purple-50 text-purple-800" readOnly={isReadOnly}>
                                                        {data.businessIncome.items.workshops.map(i => (
                                                            <div key={i.id} className="py-3 border-b border-gray-50 last:border-0">
                                                                <div className="flex justify-between items-start mb-1">
                                                                    <span className="text-sm font-bold text-gray-700">{i.name}</span>
                                                                    {!isReadOnly && <button onClick={() => updateBizList('workshops', l => l.filter(x => x.id !== i.id))} className="text-gray-300 hover:text-red-500"><Trash2 size={14}/></button>}
                                                                </div>
                                                                <div className="flex justify-between items-center text-xs text-gray-500 bg-gray-50 p-2 rounded-lg">
                                                                    <div>{formatCurrency(i.pricePerPerson)} x {i.count} pers.</div>
                                                                    <div className="font-bold text-purple-600 text-sm">{formatCurrency(i.pricePerPerson * i.count)}</div>
                                                                </div>
                                                            </div>
                                                        ))}
                                                        {!isReadOnly && (
                                                            <div className="mt-2 p-3 border border-dashed border-purple-200 rounded-xl bg-purple-50/30">
                                                                <input className="w-full bg-transparent text-sm font-medium outline-none placeholder-gray-400 mb-2" placeholder="Nombre Taller..." value={newBizWorkshop.name} onChange={e => setNewBizWorkshop({...newBizWorkshop, name: e.target.value})} />
                                                                <div className="flex gap-2">
                                                                    <div className="relative flex-1">
                                                                        <span className="absolute left-2 top-1/2 -translate-y-1/2 text-gray-400 text-[10px]">$</span>
                                                                        <CurrencyInput className="w-full bg-white border border-gray-200 rounded-lg pl-4 pr-2 py-1.5 text-xs outline-none focus:border-purple-400" placeholder="Valor p/p" value={newBizWorkshop.price} onChange={val => setNewBizWorkshop({...newBizWorkshop, price: val})} />
                                                                    </div>
                                                                    <div className="relative w-20">
                                                                        <input type="number" className="w-full bg-white border border-gray-200 rounded-lg px-2 py-1.5 text-xs outline-none focus:border-purple-400 text-center" placeholder="N¬∞ Pers" value={newBizWorkshop.count} onChange={e => setNewBizWorkshop({...newBizWorkshop, count: e.target.value})} />
                                                                    </div>
                                                                    <button onClick={() => { if(!newBizWorkshop.name || !newBizWorkshop.price || !newBizWorkshop.count) return; updateBizList('workshops', l => [...l, {id: Date.now(), name: newBizWorkshop.name, pricePerPerson: Number(newBizWorkshop.price), count: Number(newBizWorkshop.count)}]); setNewBizWorkshop({name:'', price:'', count:''}); }} className="bg-purple-600 text-white rounded-lg px-3 hover:bg-purple-700"><Plus size={16}/></button>
                                                                </div>
                                                            </div>
                                                        )}
                                                    </SectionCard>
                                                )}

                                                {data.businessIncome.types.supplies && (
                                                    <SectionCard title="Venta de Insumos" icon={Store} total={bizSuppliesTotal} colorClass="bg-white" headerClass="bg-orange-50 text-orange-800" readOnly={isReadOnly}>
                                                        {data.businessIncome.items.supplies.map(i => (
                                                            <div key={i.id} className="flex justify-between items-center py-2 border-b border-gray-50 last:border-0">
                                                                <span className="text-sm font-medium text-gray-700">{i.name}</span>
                                                                <div className="flex items-center gap-2">
                                                                    <span className="font-bold text-gray-800">{formatCurrency(i.amount)}</span>
                                                                    {!isReadOnly && <button onClick={() => updateBizList('supplies', l => l.filter(x => x.id !== i.id))} className="text-gray-300 hover:text-red-500"><Trash2 size={14}/></button>}
                                                                </div>
                                                            </div>
                                                        ))}
                                                        {!isReadOnly && <AddItemRow placeholder="Insumo..." name={newBizSupply.name} amount={newBizSupply.amount} onNameChange={e=>setNewBizSupply({...newBizSupply, name:e.target.value})} onAmountChange={val=>setNewBizSupply({...newBizSupply, amount:val})} onAdd={() => { if(!newBizSupply.name || !newBizSupply.amount) return; updateBizList('supplies', l => [...l, {id: Date.now(), name: newBizSupply.name, amount: Number(newBizSupply.amount)}]); setNewBizSupply({name:'', amount:''}); }} />}
                                                    </SectionCard>
                                                )}
                                            </>
                                        )}
                                    </div>
                                )}

                                {currentView === 'hogar' && (
                                    <div className="max-w-[720px] mx-auto space-y-6">
                                        <div className="rounded-[2rem] p-6 border transition-all duration-500 relative overflow-hidden bg-white shadow-sm border-gray-200">
                                            <div className="flex items-center justify-between mb-4">
                                                <div className="flex items-center gap-3"><div className={`p-2.5 rounded-xl bg-gray-100 text-gray-600`}><LayoutDashboard size={20}/></div><div><h3 className="font-bold text-gray-800 text-sm">Resumen {LABELS.hogarTitle}</h3><p className="text-[10px] text-gray-400 font-medium uppercase tracking-wider">{new Date().toLocaleString('es-CL', { month: 'long' })}</p></div></div>
                                                <div className={`px-3 py-1 rounded-full text-[10px] font-bold flex items-center gap-1.5 ${hogarPending === 0 ? 'bg-emerald-100 text-emerald-700' : 'bg-orange-50 text-orange-700 border border-orange-100'}`}>{hogarPending === 0 ? <CheckCircle2 size={12}/> : <AlertTriangle size={12}/>}{hogarPending === 0 ? 'Todo Pagado' : 'Pagos Pendientes'}</div>
                                            </div>
                                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                                {[{ label: LABELS.hogarTitle, icon: LABELS.hogarIcon, val: totals.hogar - totals.hogarPaid }, { label: 'Suscripciones', icon: Smartphone, val: totals.subscriptions - totals.subscriptionsPaid }, { label: 'Variables', icon: Coffee, val: totals.street - totals.streetPaid }, { label: 'Otros M√≥dulos', icon: MapPin, val: customTotal - customPaid }].map((stat, i) => (
                                                    <div key={i} className="flex items-center gap-3 p-2 rounded-lg bg-gray-50 border border-gray-100">
                                                        <div className={`text-xs p-1.5 rounded-md ${stat.val > 0 ? 'bg-white text-gray-500 shadow-sm' : 'bg-emerald-50 text-emerald-600'}`}>{stat.val === 0 ? <Check size={12}/> : <stat.icon size={12} />}</div>
                                                        <div className="flex flex-col"><span className="text-[10px] text-gray-400 font-bold uppercase">{stat.label}</span><span className={`text-xs font-bold ${stat.val > 0 ? 'text-gray-700' : 'text-emerald-600 opacity-60'}`}>{stat.val === 0 ? 'Pagado' : formatCurrency(stat.val)}</span></div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                        
                                        <SectionCard title={LABELS.hogarTitle} icon={LABELS.hogarIcon} total={totals.hogar} paid={totals.hogarPaid} colorClass="bg-white" headerClass="bg-emerald-50 text-emerald-800" readOnly={isReadOnly}>
                                            {data.hogar.length === 0 && !isReadOnly && <p className="text-xs text-gray-400 italic text-center py-2">Agrega tus gastos fijos aqu√≠</p>}
                                            {data.hogar.map(i => <EditableRow key={i.id} item={i} readOnly={isReadOnly} onToggle={()=>togglePaid('hogar',i.id)} onAmountChange={(v)=>updateAmount('hogar',i.id,v)} onNameChange={(v)=>updateName('hogar',i.id,v)} showDelete={true} onDelete={()=>delItem('hogar',i.id)}/>)}
                                            {!isReadOnly && <AddItemRow name={newHogarItem.name} amount={newHogarItem.amount} onNameChange={e=>setNewHogarItem({...newHogarItem, name:e.target.value})} onAmountChange={val=>setNewHogarItem({...newHogarItem, amount:val})} onAdd={()=>addItem('hogar', newHogarItem, setNewHogarItem)} />}
                                        </SectionCard>
                                        
                                        {data.customModules.map(mod => (<SectionCard key={mod.id} title={mod.name} icon={MapPin} total={calcTotal(mod.items)} paid={calcPaid(mod.items)} colorClass="bg-white" headerClass="bg-orange-50 text-orange-800" readOnly={isReadOnly} onTitleChange={(val) => updateCustomModuleName(mod.id, val)} onDeleteSection={()=>{if(window.confirm('Borrar?')) setData({...data, customModules: data.customModules.filter(m=>m.id!==mod.id)})}}>{mod.items.map(i => <EditableRow key={i.id} item={i} readOnly={isReadOnly} onToggle={()=>{ const newData = data.customModules.map(m => m.id === mod.id ? {...m, items: m.items.map(it => it.id === i.id ? {...it, paid: !it.paid} : it)} : m); updateCustomModules(() => newData); }} onAmountChange={(v)=>{ const newData = data.customModules.map(m => m.id === mod.id ? {...m, items: m.items.map(it => it.id === i.id ? {...it, amount: v} : it)} : m); updateCustomModules(() => newData); }} onNameChange={(v)=>{ const newData = data.customModules.map(m => m.id === mod.id ? {...m, items: m.items.map(it => it.id === i.id ? {...it, name: v} : it)} : m); updateCustomModules(() => newData); }} showDelete={true} onDelete={()=>{ const newData = data.customModules.map(m => m.id === mod.id ? {...m, items: m.items.filter(it => it.id !== i.id)} : m); updateCustomModules(() => newData); }}/>)}{!isReadOnly && <AddItemRow name={customModuleInputs[mod.id]?.name || ''} amount={customModuleInputs[mod.id]?.amount || ''} onNameChange={e=>setCustomModuleInputs({...customModuleInputs, [mod.id]: {...customModuleInputs[mod.id], name:e.target.value}})} onAmountChange={val=>setCustomModuleInputs({...customModuleInputs, [mod.id]: {...customModuleInputs[mod.id], amount:val}})} onAdd={()=>{ const input = customModuleInputs[mod.id]; if(!input?.name || !input?.amount) return; const newData = data.customModules.map(m => m.id === mod.id ? {...m, items: [...m.items, {id: Date.now(), name: input.name, amount: Number(input.amount), paid: false}]} : m); updateCustomModules(() => newData); setCustomModuleInputs({...customModuleInputs, [mod.id]: {name:'', amount:''}}); }} />}</SectionCard>))}
                                        {!isReadOnly && <button onClick={() => updateCustomModules(list => [...list, { id: Date.now(), name: 'Nuevo M√≥dulo', items: [] }])} className="w-full py-8 border-2 border-dashed border-gray-200 rounded-2xl text-gray-400 font-bold text-sm hover:bg-gray-50 hover:border-emerald-200 hover:text-emerald-600 transition-all flex flex-col items-center justify-center gap-2"><Plus size={24} /> Crear Nuevo M√≥dulo</button>}
                                        <SectionCard title="Suscripciones" icon={Smartphone} total={totals.subscriptions} paid={totals.subscriptionsPaid} colorClass="bg-white" headerClass="bg-purple-50 text-purple-800" readOnly={isReadOnly}>{data.subscriptions.map(i => <EditableRow key={i.id} item={i} readOnly={isReadOnly} onToggle={()=>togglePaid('subscriptions',i.id)} onAmountChange={(v)=>updateAmount('subscriptions',i.id,v)} onNameChange={(v)=>updateName('subscriptions',i.id,v)} showDelete={true} onDelete={()=>delItem('subscriptions',i.id)}/>)}{!isReadOnly && <AddItemRow placeholder="Netflix, Spotify..." name={newSubscriptionItem.name} amount={newSubscriptionItem.amount} onNameChange={e=>setNewSubscriptionItem({...newSubscriptionItem, name:e.target.value})} onAmountChange={val=>setNewSubscriptionItem({...newSubscriptionItem, amount:val})} onAdd={()=>addItem('subscriptions', newSubscriptionItem, setNewSubscriptionItem)} />}</SectionCard>
                                        <SectionCard title="Gastos Varios" icon={Coffee} total={totals.street} paid={totals.streetPaid} colorClass="bg-white" headerClass="bg-blue-50 text-blue-800" readOnly={isReadOnly}>{data.streetFood.map(i => <EditableRow key={i.id} item={i} readOnly={isReadOnly} onToggle={()=>togglePaid('streetFood',i.id)} onAmountChange={(v)=>updateAmount('streetFood',i.id,v)} onNameChange={(v)=>updateName('streetFood',i.id,v)} showDelete={true} onDelete={()=>delItem('streetFood',i.id)}/>)}{!isReadOnly && <AddItemRow placeholder="Caf√©, Estacionamiento..." name={newStreetItem.name} amount={newStreetItem.amount} onNameChange={e=>setNewStreetItem({...newStreetItem, name:e.target.value})} onAmountChange={val=>setNewStreetItem({...newStreetItem, amount:val})} onAdd={()=>addItem('streetFood', newStreetItem, setNewStreetItem)} />}</SectionCard>
                                    </div>
                                )}

                                {currentView === 'tarjetas' && (
                                    <div className="max-w-[720px] mx-auto">
                                        <SectionCard title="Gesti√≥n de Tarjetas" icon={CreditCard} total={totals.creditCards} headerClass={`text-rose-800 ${isReadOnly ? 'bg-gray-200 text-gray-600' : 'bg-rose-50'}`} readOnly={isReadOnly}>
                                            <div className="space-y-6 mt-4">
                                                {uniqueBanks.map(bank => { const bankItems = (data.creditCards || []).filter(item => item.bank === bank); return (<div key={bank} className="bg-white rounded-xl border border-rose-100 shadow-sm overflow-hidden h-full flex flex-col"><div className="bg-rose-50/50 px-4 py-3 border-b border-rose-100 flex justify-between items-center"><h4 className="text-xs font-bold text-rose-900 uppercase tracking-widest flex items-center gap-2"><Building2 size={14} className="text-rose-400"/> {bank}</h4>{!isReadOnly && <button onClick={() => { if(window.confirm(`¬øEliminar ${bank}?`)) updateList('creditCards', list => list.filter(c => c.bank !== bank)) }} className="text-rose-300 hover:text-rose-600"><Trash2 size={16} /></button>}</div><div className="px-4 py-3 flex-1">{bankItems.map(item => (<DetailedCreditCardRow key={item.id} item={item} readOnly={isReadOnly} onUpdate={(field, val) => updateCard(item.id, field, val)} onDelete={() => deleteItem('creditCards', item.id)}/>))}</div></div>) })}
                                                {!isAddingBank && !isReadOnly && (<button onClick={() => setIsAddingBank(true)} className="w-full min-h-[100px] border-2 border-dashed border-rose-200 rounded-xl text-rose-400 font-bold text-sm hover:bg-rose-50 transition flex flex-col items-center justify-center gap-2"><Plus size={24} /> Agregar Banco</button>)}
                                                {isAddingBank && (<div className="bg-gray-50 p-4 rounded-xl border border-gray-200 h-full"><h4 className="text-xs font-bold text-gray-500 uppercase mb-3">Nuevo Banco</h4><input autoFocus className="w-full border border-gray-300 rounded px-3 py-2 text-sm mb-3 focus:outline-none focus:border-rose-500" placeholder="Nombre (Ej. Scotiabank)" value={newBankName} onChange={(e) => setNewBankName(e.target.value)}/><div className="flex flex-wrap gap-2 mb-4"><label className="flex items-center gap-2 bg-white px-3 py-1.5 rounded-lg border text-sm cursor-pointer hover:border-rose-300"><input type="checkbox" checked={newBankTypes.pesos} onChange={e => setNewBankTypes({...newBankTypes, pesos: e.target.checked})} className="accent-rose-500"/> TC Pesos</label><label className="flex items-center gap-2 bg-white px-3 py-1.5 rounded-lg border text-sm cursor-pointer hover:border-rose-300"><input type="checkbox" checked={newBankTypes.dolares} onChange={e => setNewBankTypes({...newBankTypes, dolares: e.target.checked})} className="accent-rose-500"/> TC D√≥lares</label><label className="flex items-center gap-2 bg-white px-3 py-1.5 rounded-lg border text-sm cursor-pointer hover:border-rose-300"><input type="checkbox" checked={newBankTypes.linea} onChange={e => setNewBankTypes({...newBankTypes, linea: e.target.checked})} className="accent-rose-500"/> L√≠nea</label></div><div className="flex gap-2"><button onClick={addBank} className="flex-1 bg-rose-600 text-white py-2 rounded-lg font-bold text-sm hover:bg-rose-700">Guardar</button><button onClick={() => setIsAddingBank(false)} className="px-4 text-gray-500 text-sm hover:text-gray-800">Cancelar</button></div></div>)}
                                            </div>
                                        </SectionCard>
                                    </div>
                                )}

                                {currentView === 'supermercado' && (
                                    <div className="max-w-[720px] mx-auto space-y-6">
                                        {!activeListId ? (
                                            <>
                                                <SectionCard title={LABELS.superTitle} icon={ShoppingCart} total={totals.supermarket} headerClass={`text-gray-700 ${isReadOnly ? 'bg-gray-200' : 'bg-gray-50'}`} readOnly={isReadOnly}>
                                                    <div className="space-y-6">
                                                        <div className={`p-5 rounded-2xl border transition-colors duration-300 ${marketBudget > 0 && marketSpent > marketBudget ? 'bg-red-50 border-red-100' : 'bg-gray-50 border-gray-100'}`}>
                                                            <div className="flex justify-between items-center mb-2"><label className="text-xs font-bold text-gray-500 uppercase tracking-wider flex items-center gap-1"><Banknote size={14}/> Presupuesto Mensual</label>{marketBudget > 0 && (<span className={`text-[10px] uppercase font-bold px-2 py-0.5 rounded-full ${marketSpent > marketBudget ? 'bg-red-100 text-red-600' : 'bg-emerald-100 text-emerald-600'}`}>{marketSpent > marketBudget ? 'Excedido' : 'En Rango'}</span>)}</div>
                                                            <div className="relative"><span className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-bold text-lg">$</span><CurrencyInput disabled={isReadOnly} placeholder="0" value={data.supermarket?.budget || ''} onChange={(val) => !isReadOnly && setData({...data, supermarket: {...data.supermarket, budget: val}})} className="w-full pl-9 pr-4 py-3 bg-white border border-gray-200 rounded-xl text-2xl font-bold text-gray-800 focus:outline-none focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 transition-all shadow-sm disabled:bg-gray-100" /></div>
                                                            {marketBudget > 0 && (<div className="mt-5"><div className="flex justify-between text-xs mb-2 font-medium"><span className={`${marketSpent > marketBudget ? 'text-red-600' : 'text-gray-600'}`}>Gastado: <span className="font-bold text-lg align-middle">{formatCurrency(marketSpent)}</span></span><span className="text-gray-400">Meta: {formatCurrency(marketBudget)}</span></div><div className="w-full bg-gray-200/80 rounded-full h-3 overflow-hidden"><div className={`h-full rounded-full transition-all duration-500 ${marketSpent > marketBudget ? 'bg-red-500' : marketRatio >= 0.8 ? 'bg-orange-500' : 'bg-emerald-500'}`} style={{ width: `${Math.min((marketSpent / marketBudget) * 100, 100)}%` }}></div></div><div className="text-right mt-1"><span className="text-xs font-bold text-gray-400">Restante: {formatCurrency(Math.max(0, marketBudget - marketSpent))}</span></div></div>)}
                                                        </div>
                                                        <div>
                                                            <div className="flex items-center justify-between mb-3 px-1 pt-2 border-t border-gray-100"><h4 className="text-xs font-bold text-gray-400 uppercase tracking-wider flex items-center gap-2"><ShoppingCart size={14}/> Compras R√°pidas ({data.supermarket?.items?.length || 0})</h4></div>
                                                            {!isReadOnly && (<div className="mb-4"><div className="bg-white p-1.5 rounded-2xl shadow-sm border border-gray-200 flex gap-2"><input className="flex-1 bg-transparent px-4 py-3 text-sm font-medium focus:outline-none placeholder-gray-400 text-gray-800" placeholder="Nombre local..." value={newMarketItem.name} onChange={(e) => setNewMarketItem({...newMarketItem, name: e.target.value})} /><div className="w-px bg-gray-200 my-2"></div><div className="relative w-28"><span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 font-bold text-xs">$</span><CurrencyInput className="w-full bg-transparent pl-6 pr-3 py-3 text-sm font-bold focus:outline-none placeholder-gray-300 text-gray-800" placeholder="0" value={newMarketItem.amount} onChange={(val) => setNewMarketItem({...newMarketItem, amount: val})} /></div><button onClick={() => { if (!newMarketItem.amount) return; setData({...data, supermarket: {...data.supermarket, items: [...(data.supermarket?.items || []), {id: Date.now(), name: newMarketItem.name || 'Compra', amount: Number(newMarketItem.amount)}]}}); setNewMarketItem({ name: '', amount: '' }); }} disabled={!newMarketItem.amount} className="bg-indigo-600 text-white rounded-xl w-12 flex items-center justify-center hover:bg-indigo-700 disabled:opacity-50 disabled:bg-gray-300 transition-all shadow-md"><Plus size={20} /></button></div></div>)}
                                                            <div className="space-y-2.5 max-h-[300px] overflow-y-auto">{(data.supermarket?.items || []).length === 0 && (<div className="text-center py-4 text-gray-400 text-xs italic">Sin compras r√°pidas registradas</div>)}{(data.supermarket?.items || []).map(item => (<div key={item.id} className="flex justify-between items-center p-3.5 bg-white border border-gray-100 rounded-2xl shadow-sm"><div className="flex items-center gap-3"><div className={`p-2 rounded-xl shrink-0 ${item.inexact ? 'bg-orange-100 text-orange-500' : 'bg-gray-100 text-gray-500'}`}>{item.inexact ? <AlertTriangle size={16}/> : <ShoppingCart size={16} />}</div><div><span className="text-sm font-bold text-gray-700 block">{item.name}</span>{item.inexact && <span className="text-[10px] text-orange-500 font-medium">Valor inexacto</span>}</div></div><div className="flex items-center gap-3"><span className={`text-sm font-bold px-2 py-1 rounded-lg border ${item.inexact ? 'text-orange-600 bg-orange-50 border-orange-100' : 'text-gray-900 bg-gray-50 border-gray-100'}`}>{formatCurrency(item.amount)}</span>{!isReadOnly && (<button onClick={() => setData({...data, supermarket: {...data.supermarket, items: data.supermarket.items.filter(i => i.id !== item.id)}})} className="text-gray-300 hover:text-red-500 hover:bg-red-50 p-1.5 rounded-lg transition-all"><Trash2 size={16} /></button>)}</div></div>))}</div>
                                                        </div>
                                                    </div>
                                                </SectionCard>
                                                
                                                <div className="bg-indigo-50 rounded-2xl p-6 border border-indigo-100">
                                                    <div className="flex justify-between items-center mb-6"><h4 className="text-sm font-bold text-indigo-800 uppercase tracking-wider flex items-center gap-2"><List size={16}/> {LABELS.listTitle}</h4></div>
                                                    <div className="space-y-3 mb-6">{(data.supermarket?.lists || []).length === 0 && <div className="text-center py-10 text-gray-400 text-sm italic border-2 border-dashed border-indigo-200 rounded-xl">No tienes listas activas</div>}{(data.supermarket?.lists || []).map(list => { const listCheckedTotal = list.items.filter(i => i.checked).reduce((acc, i) => acc + (Number(i.price)||0), 0); const listFullTotal = list.items.reduce((acc, i) => acc + (Number(i.price)||0), 0); const itemsChecked = list.items.filter(i => i.checked).length; const hasMissingPrices = list.items.some(i => !i.price || Number(i.price) === 0); return (<div key={list.id} onClick={() => setActiveListId(list.id)} className={`bg-white p-4 rounded-xl border shadow-sm flex justify-between items-center cursor-pointer transition-all relative group hover:shadow-md ${hasMissingPrices ? 'border-orange-200 shadow-orange-50' : 'border-indigo-50 hover:border-indigo-300'}`}><div className="flex items-center gap-4"><div className={`p-3 rounded-xl ${hasMissingPrices ? 'bg-orange-100 text-orange-500' : 'bg-indigo-100 text-indigo-600'}`}>{hasMissingPrices ? <AlertTriangle size={20}/> : <ShoppingCart size={20}/>}</div><div><p className="font-bold text-gray-800">{list.name}</p><div className="flex items-center gap-2 mt-1"><p className="text-xs text-gray-500 font-medium">{itemsChecked}/{list.items.length} productos</p>{hasMissingPrices && <span className="text-[9px] font-bold text-orange-500 bg-orange-50 px-1.5 rounded">Revisar Precios</span>}</div></div></div><div className="flex items-center gap-3">{!isReadOnly && itemsChecked > 0 && (<button onClick={(e) => { e.stopPropagation(); handleFinishList(list); }} className="p-2 bg-emerald-100 text-emerald-600 rounded-lg hover:bg-emerald-500 hover:text-white transition-all shadow-sm" title="Finalizar compra"><CheckCircle2 size={20}/></button>)}<div className="text-right pl-3 border-l border-gray-100"><span className={`block font-bold ${hasMissingPrices ? 'text-orange-600' : 'text-indigo-600'}`}>{formatCurrency(listCheckedTotal)}</span><span className="text-[10px] text-gray-400 block font-medium">Est. {formatCurrency(listFullTotal)}</span>{!isReadOnly && (<button onClick={(e) => { e.stopPropagation(); if(window.confirm("¬øEliminar lista?")) { const newLists = data.supermarket.lists.filter(l => l.id !== list.id); setData({...data, supermarket: { ...data.supermarket, lists: newLists }}); } }} className="text-[10px] text-red-300 hover:text-red-500 block ml-auto mt-1 font-bold">Eliminar</button>)}</div></div></div>) })}</div>
                                                    {!isReadOnly && (<button onClick={handleCreateList} className="w-full py-4 bg-white border-2 border-dashed border-indigo-200 rounded-xl text-indigo-500 font-bold text-sm hover:bg-indigo-50 transition flex items-center justify-center gap-2"><Plus size={18} /> Crear Nueva Lista</button>)}
                                                </div>
                                            </>
                                        ) : (
                                            <div className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden min-h-[600px] flex flex-col">
                                                <div className="bg-indigo-600 p-6 pb-8"><label className="text-xs text-indigo-200 font-bold uppercase mb-2 block">Nombre Lista</label><input value={activeList.name} disabled={isReadOnly} onChange={(e) => updateActiveList({ ...activeList, name: e.target.value })} className="w-full bg-transparent text-3xl font-bold text-white placeholder-indigo-300 focus:outline-none border-b border-indigo-400/50 pb-2" placeholder="Ej. Semanal..." /></div>
                                                <div className="flex-1 p-6 md:p-8 -mt-6 bg-white rounded-t-3xl flex flex-col">
                                                    {itemsWithoutPrice > 0 && (<div className="mb-6 bg-orange-50 border border-orange-100 p-4 rounded-xl flex items-start gap-3"><AlertTriangle className="text-orange-500 shrink-0 mt-0.5" size={20}/><div><p className="font-bold text-orange-700">Atenci√≥n: Precios incompletos</p><p className="text-sm text-orange-600">Hay {itemsWithoutPrice} productos sin precio. El total podr√≠a no ser exacto.</p></div></div>)}
                                                    {!isReadOnly && (<div className="flex gap-3 mb-6"><input className="flex-1 bg-gray-50 border border-gray-200 rounded-xl px-5 py-4 text-base focus:outline-none focus:border-indigo-500 transition-colors" placeholder="Agregar producto..." value={newProduct.name} onChange={(e) => setNewProduct({...newProduct, name: e.target.value})} onKeyDown={(e) => { if (e.key === 'Enter' && newProduct.name.trim()) { updateActiveList({ ...activeList, items: [...activeList.items, { id: Date.now(), name: newProduct.name, price: newProduct.price, checked: false }] }); setNewProduct({ name: '', price: '' }); } }} /><div className="relative w-32 shrink-0"><span className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-xs font-bold">$</span><CurrencyInput className="w-full bg-gray-50 border border-gray-200 rounded-xl pl-7 pr-4 py-4 text-base focus:outline-none focus:border-indigo-500 transition-colors" placeholder="0" value={newProduct.price} onChange={(val) => setNewProduct({...newProduct, price: val})} onKeyDown={(e) => { if (e.key === 'Enter' && newProduct.name.trim()) { updateActiveList({ ...activeList, items: [...activeList.items, { id: Date.now(), name: newProduct.name, price: newProduct.price, checked: false }] }); setNewProduct({ name: '', price: '' }); } }} /></div><button onClick={() => { if (!newProduct.name.trim()) return; updateActiveList({ ...activeList, items: [...activeList.items, { id: Date.now(), name: newProduct.name, price: newProduct.price, checked: false }] }); setNewProduct({ name: '', price: '' }); }} disabled={!newProduct.name.trim()} className="bg-indigo-600 text-white rounded-xl w-14 flex items-center justify-center hover:bg-indigo-700 disabled:opacity-50 transition-colors shadow-sm"><Plus size={24}/></button></div>)}
                                                    <div className="space-y-2 flex-1 overflow-y-auto pr-2">{activeList.items.length === 0 && (<div className="text-center py-20 text-gray-400">Tu lista est√° vac√≠a.<br/>Agrega productos arriba ‚òùÔ∏è</div>)}{activeList.items.map(item => (<div key={item.id} className={`flex items-center gap-4 p-4 rounded-xl border transition-all hover:bg-gray-50 ${item.checked ? 'bg-indigo-50 border-indigo-100' : 'bg-white border-gray-100'}`}><button disabled={isReadOnly} onClick={() => { const newItems = activeList.items.map(i => i.id === item.id ? { ...i, checked: !i.checked } : i); updateActiveList({ ...activeList, items: newItems }); }} className={`shrink-0 transition-colors ${item.checked ? 'text-indigo-600' : 'text-gray-300 hover:text-gray-400'}`}>{item.checked ? <CheckCircle2 size={28} className="fill-indigo-100"/> : <Circle size={28}/>}</button><div className="flex-1 min-w-0"><p className={`text-base font-medium truncate ${item.checked ? 'text-indigo-800 line-through decoration-indigo-300' : 'text-gray-800'}`}>{item.name}</p></div><div className="relative w-28 shrink-0">{(!item.price || item.price == 0) && (<span className="absolute -left-6 top-1/2 -translate-y-1/2 text-orange-400" title="Sin precio"><AlertTriangle size={16}/></span>)}<span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs">$</span><CurrencyInput disabled={isReadOnly} value={item.price} onChange={(val) => { const newItems = activeList.items.map(i => i.id === item.id ? { ...i, price: val } : i); updateActiveList({ ...activeList, items: newItems }); }} className={`w-full bg-transparent border-b border-dashed text-right pr-2 py-2 font-bold focus:outline-none focus:border-indigo-500 ${item.price > 0 ? (item.checked ? 'text-indigo-600 border-indigo-200' : 'text-gray-800 border-gray-300') : 'text-gray-400 border-orange-300'}`} placeholder="0" /></div>{!isReadOnly && (<button onClick={() => { const newItems = activeList.items.filter(i => i.id !== item.id); updateActiveList({ ...activeList, items: newItems }); }} className="text-gray-300 hover:text-red-500 p-2"><Trash2 size={18}/></button>)}</div>))}</div>
                                                    <div className="mt-6 pt-6 border-t border-gray-100"><div className="flex justify-between items-center text-sm mb-2"><span className="text-gray-400 font-medium">Estimado Total Lista</span><span className="font-bold text-gray-400 text-lg">{formatCurrency(activeListTotal)}</span></div><div className="flex justify-between items-center"><span className="text-xl font-bold text-gray-800">Total en Carrito</span><span className="text-4xl font-extrabold text-indigo-600">{formatCurrency(activeList.items.filter(i => i.checked).reduce((a,b)=>a+(Number(b.price)||0),0))}</span></div></div>
                                                    {!isReadOnly && (<div className="mt-8 flex justify-end"><button type="button" onClick={() => { if(window.confirm("¬øEliminar lista completa?")) { const newLists = data.supermarket.lists.filter(l => l.id !== activeListId); setData({...data, supermarket: { ...data.supermarket, lists: newLists }}); setActiveListId(null); }}} className="text-red-400 text-sm font-bold hover:text-red-600 flex items-center gap-2 px-4 py-2 hover:bg-red-50 rounded-lg transition-colors"><Trash2 size={16}/> Eliminar esta lista</button></div>)}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                )}

                                {currentView === 'graficos' && (
                                    <div className="max-w-[720px] mx-auto space-y-6">
                                        <div className="col-span-full flex bg-gray-100 p-1 rounded-xl gap-1 max-w-md mx-auto mb-4">{[{id: 'general', label: 'Resumen'}, {id: 'tarjetas', label: 'Tarjetas'}, {id: 'ahorro', label: 'Ahorro'}].map(t => (<button key={t.id} onClick={() => setChartTab(t.id)} className={`flex-1 py-2 px-4 rounded-lg text-sm font-bold transition-all ${chartTab === t.id ? 'bg-white text-indigo-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}>{t.label}</button>))}</div>
                                        {chartTab === 'general' && <div className="bg-white p-8 rounded-3xl shadow-sm border border-gray-100"><h3 className="text-xl font-bold text-gray-800 mb-8 flex items-center gap-2"><PieChart size={24} className="text-indigo-500"/> Distribuci√≥n de Gastos</h3><SimplePieChart data={expenseDistribution} /></div>}
                                        {chartTab === 'tarjetas' && <div className="bg-white p-8 rounded-3xl shadow-sm border border-gray-100"><h3 className="text-xl font-bold text-gray-800 mb-8 flex items-center gap-2"><CreditCard size={24} className="text-rose-500"/> Deuda vs Pagos</h3>{creditCardUsage.length === 0 ? <p className="text-gray-400 italic text-center py-4">No hay tarjetas registradas.</p> : creditCardUsage.map((c, i) => <ProgressBar key={i} label={c.label} value={c.paid} total={c.total} colorClass="bg-rose-500" />)}</div>}
                                        {chartTab === 'ahorro' && <div className="bg-white p-8 rounded-3xl shadow-sm border border-gray-100"><h3 className="text-xl font-bold text-gray-800 mb-8 flex items-center gap-2"><PiggyBank size={24} className="text-emerald-500"/> Capacidad de Ahorro</h3><ProgressBar label="Ahorro vs Ingreso" value={totalAhorros} total={totalIncome} colorClass="bg-emerald-500" /><div className="mt-8 pt-8 border-t border-gray-100"><p className="text-xs text-gray-400 uppercase font-bold mb-4">Resumen Financiero</p><div className="flex justify-between items-center mb-3"><span className="text-gray-600">Ingresos Totales</span><span className="font-bold text-green-600 text-lg">{formatCurrency(totalIncome)}</span></div><div className="flex justify-between items-center mb-3"><span className="text-gray-600">Gastos + Salidas</span><span className="font-bold text-red-500 text-lg">{formatCurrency(grandTotalExpenses + totalAhorros)}</span></div><div className="flex justify-between items-center pt-4 border-t border-dashed border-gray-100"><span className="font-bold text-gray-800">Margen Libre</span><span className="font-bold text-blue-600 text-2xl">{formatCurrency(projectedBalance)}</span></div></div></div>}
                                    </div>
                                )}

                                {currentView === 'ahorros' && (
                                    <div className="max-w-[720px] mx-auto space-y-6">
                                        <SectionCard title="Reservas" icon={PiggyBank} total={totals.savings} colorClass="bg-white" headerClass="bg-emerald-50 text-emerald-800" readOnly={isReadOnly}>
                                            {data.savings.map(i => <EditableRow key={i.id} item={i} readOnly={isReadOnly} onToggle={()=>togglePaid('savings',i.id)} onAmountChange={(v)=>updateAmount('savings',i.id,v)} onNameChange={(v)=>updateName('savings',i.id,v)} showDelete={true} onDelete={()=>delItem('savings',i.id)}/>)}
                                            {!isReadOnly && <div className="mt-2 flex gap-2"><input className="border rounded px-2 py-1 w-full text-sm" placeholder="Meta..." value={newSavingsItem.name} onChange={e=>setNewSavingsItem({...newSavingsItem, name:e.target.value})}/><CurrencyInput className="border rounded px-2 py-1 w-24 text-sm" placeholder="$" value={newSavingsItem.amount} onChange={val=>setNewSavingsItem({...newSavingsItem, amount:val})}/><button onClick={()=>addItem('savings', newSavingsItem, setNewSavingsItem)} className="bg-emerald-500 text-white rounded px-2"><Plus/></button></div>}
                                        </SectionCard>
                                        <SectionCard title="Pr√©stamos a Terceros" icon={Users} total={totals.loansGiven} colorClass="bg-white" headerClass="bg-orange-50 text-orange-800" readOnly={isReadOnly}>
                                            {data.loansGiven.map(i => <EditableRow key={i.id} item={i} readOnly={isReadOnly} onToggle={()=>togglePaid('loansGiven',i.id)} onAmountChange={(v)=>updateAmount('loansGiven',i.id,v)} onNameChange={(v)=>updateName('loansGiven',i.id,v)} showDelete={true} onDelete={()=>delItem('loansGiven',i.id)}/>)}
                                            {!isReadOnly && <div className="mt-2 flex gap-2"><input className="border rounded px-2 py-1 w-full text-sm" placeholder="A qui√©n..." value={newLoanItem.name} onChange={e=>setNewLoanItem({...newLoanItem, name:e.target.value})}/><CurrencyInput className="border rounded px-2 py-1 w-24 text-sm" placeholder="$" value={newLoanItem.amount} onChange={val=>setNewLoanItem({...newLoanItem, amount:val})}/><button onClick={()=>addItem('loansGiven', newLoanItem, setNewLoanItem)} className="bg-orange-500 text-white rounded px-2"><Plus/></button></div>}
                                        </SectionCard>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><App /></ErrorBoundary>);
    </script>
</body>
</html>
